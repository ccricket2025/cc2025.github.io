<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Cricket Play - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-color: #3498db; /* Bright Blue */
            --primary-dark-color: #2980b9;
            --accent-color: #2ecc71; /* Emerald Green */
            --background-color: #f4f6f8; /* Softer White */
            --surface-color: #ffffff;
            --text-primary-color: #34495e; /* Wet Asphalt */
            --text-secondary-color: #95a5a6; /* Silver */
            --divider-color: #e0e0e0;
            --danger-color: #e74c3c; /* Alizarin Red */
            --success-color: #27ae60;
            --warning-color: #f39c12; /* Orange */
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary-color);
            overscroll-behavior-y: contain;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 15px;
        }

        /* --- Login Screen --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-dark-color), var(--primary-color));
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #login-box {
            background-color: var(--surface-color);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 320px;
            text-align: center;
        }
        #login-box h2 {
            margin-top: 0;
            color: var(--primary-dark-color);
        }
        /* --- *** UPDATED LOGIN FORM STYLES *** --- */
        #login-box .form-group {
            margin-bottom: 16px;
            text-align: left;
        }
        #login-box .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #7f8c8d;
        }
        #login-box .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--divider-color);
            border-radius: 8px;
            font-size: 15px;
        }
        /* --- *** END UPDATED STYLES *** --- */


        /* Screen Management & Transitions */
        .screen {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s;
            transform: translateX(100%);
            background-color: var(--background-color);
            visibility: hidden;
            opacity: 0;
        }
        .screen.active {
            transform: translateX(0);
            z-index: 10;
            visibility: visible;
            opacity: 1;
        }
        .screen.inactive-left {
            transform: translateX(-30%);
            visibility: visible;
            opacity: 0.5;
        }

        /* App Header (Toolbar) */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark-color), var(--primary-color));
            color: white;
            padding: 0 8px; display: flex; align-items: center;
            height: 56px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: sticky; top: 0; z-index: 100; flex-shrink: 0;
        }
        .app-header .icon-button { background: none; border: none; color: white; padding: 12px; border-radius: 50%; cursor: pointer; display: flex; }
        .app-header h1 { font-size: 19px; font-weight: 500; margin: 0; flex-grow: 1; text-align: center; }
        .app-header h1:first-child { text-align: left; }

        /* Content & Cards */
        .content { padding: 16px; flex-grow: 1; overflow-y: auto; }
        .card {
            background-color: var(--surface-color);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #eef2f5;
            margin-bottom: 16px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* Forms & Buttons */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #7f8c8d; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--divider-color); border-radius: 8px; font-size: 15px; background-color: #fafafa; }

        .input-with-dropdown {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-with-dropdown input {
            flex-grow: 1;
        }
        .input-with-dropdown .icon-button {
            flex-shrink: 0;
            background-color: var(--background-color);
            color: var(--text-secondary-color);
            padding: 8px;
            height: 45px;
            width: 45px;
        }

        .btn {
            display: flex; justify-content: center; align-items: center;
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark-color));
            color: white; font-size: 15px; font-weight: 500; cursor: pointer;
            text-align: center; text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
        }
        .btn:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .btn.btn-secondary { background: linear-gradient(45deg, #bdc3c7, #95a5a6); }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }
        .btn-group .btn { flex-grow: 1; min-width: 110px; }


        /* Toggle Switch */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Bottom Navigation */
        .bottom-nav { display: flex; justify-content: space-around; background-color: var(--surface-color); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); position: sticky; bottom: 0; width: 100%; z-index: 100; flex-shrink: 0; padding: 6px 0; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .nav-item { cursor: pointer; text-align: center; flex-grow: 1; display: flex; flex-direction: column; align-items: center; color: var(--text-secondary-color); transition: color 0.2s; }
        .nav-item .material-icons { font-size: 24px; }
        .nav-item span { font-size: 12px; }
        .nav-item.active { color: var(--primary-color); }

        /* Floating Action Button */
        .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(45deg, var(--accent-color), #27ae60); color: white; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); cursor: pointer; z-index: 200; transition: transform 0.2s ease; }
        .fab:active { transform: scale(0.95); }

        /* Modal, Toast & Other UI */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--surface-color); margin: auto; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px; animation: slide-up 0.3s ease; }
        @keyframes slide-up { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #team-select-modal-list .list-item { padding: 12px; border-bottom: 1px solid var(--divider-color); cursor: pointer; transition: background-color 0.2s; }
        #team-select-modal-list .list-item:hover { background-color: var(--background-color); }

        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.87); color: white; padding: 12px 24px; border-radius: 24px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; font-size: 14px; }

        /* Player & Stats Specific Styles */
        .player-row { display: flex; align-items: center; padding: 12px 8px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s; }
        .player-row:last-child { border-bottom: none; }
        .player-row:hover { background-color: #f8f9fa; }
        .player-row span { flex-grow: 1; font-weight: 500; cursor: pointer; }
        .icon-button { background: none; border: none; padding: 8px; border-radius: 50%; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; }

        .player-profile-header { text-align: center; padding: 24px; background: linear-gradient(to top, var(--primary-color), var(--primary-dark-color)); color: white; }
        .player-profile-pic { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; background-color: #ccc; margin: 0 auto 8px auto; display: flex; justify-content: center; align-items: center; }
        .player-stats-tabs { position: static; box-shadow: none; border-bottom: 1px solid var(--divider-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
        .stat-box { background-color: #fafafa; padding: 12px; border-radius: 6px; text-align: center; }
        .stat-box .value { font-size: 19px; font-weight: 700; color: var(--primary-dark-color); }
        .stat-box .label { font-size: 12px; color: #7f8c8d; }

        /* Scorecard & Tournament Styles */
        .scoreboard {
            text-align: center; padding: 16px;
            background: linear-gradient(135deg, var(--primary-dark-color), var(--primary-color));
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .scoreboard h2 { margin: 0; font-size: 30px; font-weight: 700; }
        .scoreboard p { margin: 4px 0 0; font-size: 14px; opacity: 0.9; }

        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .score-table, .points-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 14px; min-width: 320px; }
        .score-table th, .points-table th { padding: 10px 8px; text-align: left; background-color: #e9ecef; color: var(--text-primary-color); font-weight: 600; }
        .score-table td, .points-table td { padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--divider-color); }
        .score-table tbody tr:nth-child(even), .points-table tbody tr:nth-child(even) { background-color: #f8f9fa; }

        .this-over { font-weight: 700; letter-spacing: 2px; }
        #this-over-display { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; min-height: 28px; padding-top: 4px; }
        .ball-event { display: inline-flex; justify-content: center; align-items: center; width: 28px; height: 28px; background-color: var(--primary-color); color: white; font-weight: 500; border-radius: 4px; font-size: 12px; }
        .ball-event.wicket { background-color: var(--danger-color); }

        .scoring-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
        .scoring-controls .btn { background: #95a5a6; font-size: 14px; padding: 10px 5px; }
        .scoring-controls .btn.active { background: var(--warning-color); }

        .run-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; justify-items: center; }
        .run-buttons .btn {
            padding: 0;
            font-size: 20px;
            font-weight: 700;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: var(--accent-color);
            flex-grow: 0;
            min-width: unset;
        }
        .run-buttons .btn.btn-secondary { background: var(--text-secondary-color); }

        /* Points Table Specific Overrides for better screen fit */
        .points-table {
            font-size: 13px; /* Make font smaller */
            table-layout: fixed; /* Helps with column width control */
            width: 100%;
        }
        .points-table th, .points-table td {
            padding: 8px 3px; /* Reduce horizontal padding */
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .points-table td:first-child, .points-table th:first-child {
            text-align: left;
            width: 35%; /* Give more width to team name column */
        }
        .points-table input {
            padding: 4px 2px;
            font-size: 12px;
            max-width: 40px; /* Make input boxes smaller */
            width: 100%;
            text-align: center;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        #new-match-from-scorecard-btn { position: fixed; bottom: 20px; right: 20px; width: auto; padding: 12px 20px; z-index: 200; display: none; }
        .match-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .match-row select { flex: 1; padding: 8px; border-radius: 8px; }
        .match-row span { font-weight: 500; }
        .add-btn { display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary-color); padding: 8px; border-radius: 8px; background-color: #ecf0f1; margin-top: 8px; }

        .result-match-item {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--divider-color);
        }
        .result-match-item:last-child { border-bottom: none; }
        .score-entry-row { display: flex; align-items: center; margin-bottom: 8px; gap: 12px; }
        .score-entry-row .team-name { flex: 1; font-weight: 500; }
        .score-entry-row .score-input { flex: 0 0 120px; text-align: right; padding: 8px; }
        .summary-input { width: 100%; margin-top: 8px; padding: 8px; border-radius: 8px; border: 1px solid var(--divider-color); resize: vertical; min-height: 50px; font-size: 14px; }

        #new-over-btn.alert { animation: pulse 1.5s infinite; background: linear-gradient(45deg, var(--warning-color), #f5b041); }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 2px 4px rgba(0,0,0,0.15); } 50% { transform: scale(1.05); box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4); } 100% { transform: scale(1); box-shadow: 0 2px 4px rgba(0,0,0,0.15); } }

        #summary-content .card { border: 1px solid var(--divider-color); }
        #summary-content .score-table { box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; border: 1px solid #f0f0f0; }
        #summary-content .score-table thead { background-color: #f5f5f5; }
        #summary-content .score-table th { font-weight: 700; color: var(--primary-dark-color); }
        #summary-content h3 { border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; margin-bottom: 16px; }
        #summary-content h4 { margin-top: 24px; margin-bottom: 10px; color: #7f8c8d; text-transform: uppercase; font-size: 14px; }

        .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .history-item-header h4 { margin: 0; }
        .history-item-header .date { font-size: 12px; color: var(--text-secondary-color); font-weight: 500; }
        .history-item-body p { margin: 0 0 12px 0; color: var(--accent-color); font-weight: 500; }

        /* --- Scorecard Screen Compaction Styles --- */
        #scorecard-screen .content {
            padding: 12px 10px; /* Reduced vertical and horizontal padding */
        }
        #scorecard-screen .card {
            padding: 10px;      /* Reduced card padding */
            margin-bottom: 10px; /* Reduced space between cards */
        }
        #scorecard-screen .score-table th,
        #scorecard-screen .score-table td {
            padding: 8px 6px; /* Reduced table cell padding */
            font-size: 13px; /* Slightly smaller font in tables */
        }
        #scorecard-screen .score-table th {
            font-weight: 500;
        }
        #scorecard-screen .this-over {
            font-size: 14px;
        }
        #scorecard-screen .scoring-controls {
            gap: 6px;
            margin-bottom: 10px;
        }
        #scorecard-screen .scoring-controls .btn {
            font-size: 13px;
            padding: 9px 5px; /* Adjust padding for button height */
        }
        #scorecard-screen .run-buttons {
            gap: 8px;
            margin-top: 10px;
        }
        #scorecard-screen .run-buttons .btn {
            width: 50px;
            height: 50px;
            font-size: 18px;
        }
        #scorecard-screen .btn-group {
            margin-top: 12px;
        }

        /* --- Opening Screen Adjustment --- */
        #new-match-screen .content {
            padding: 12px;
        }
        #new-match-screen .card {
            margin-bottom: 12px;
            padding: 12px;
        }
        #new-match-screen .form-group {
            margin-bottom: 12px;
        }
        #new-match-screen .btn-group {
            margin-top: 12px;
        }

        /* --- *** NEW: Full Scorecard Compaction & Detail Styles *** --- */
        #summary-content .score-table {
            font-size: 10px; /* Made smaller */
        }
        #summary-content .score-table th, #summary-content .score-table td {
            padding: 4px 2px; /* Reduced padding */
        }
        .batsman-name-cell {
            line-height: 1.3;
        }
        .dismissal-info {
            display: inline;
            margin-left: 8px; /* Added some space */
            font-size: 8px; /* Made smaller */
            color: var(--text-secondary-color);
            font-style: italic;
        }
        #summary-content h3 {
            font-size: 14px; /* Made smaller */
            padding-bottom: 6px;
            margin-bottom: 12px;
        }
        #summary-content h4 {
            font-size: 10px; /* Made smaller */
            margin-top: 16px;
            margin-bottom: 8px;
        }

        /* --- *** ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°: PDF ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ *** --- */
        .pdf-render-mode .card {
            padding: 8px;
            margin-bottom: 8px;
        }
        .pdf-render-mode h3 {
            font-size: 12px;
            margin-bottom: 8px;
            padding-bottom: 4px;
        }
        .pdf-render-mode h4 {
            font-size: 10px;
            margin-top: 10px;
            margin-bottom: 6px;
        }
        .pdf-render-mode .score-table {
            font-size: 9px;
        }
        .pdf-render-mode .score-table th,
        .pdf-render-mode .score-table td {
            padding: 4px 3px;
        }
/* --- *** ‡¶è‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® *** --- */

/* Fall of Wickets ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) */
.fow-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 12px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 6px;
    border: 1px solid #f0f0f0;
}
.fow-item {
    font-size: 10px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}
.fow-item strong {
    color: var(--danger-color);
}
.fow-separator {
    color: var(--divider-color);
    font-size: 14px;
}

/* Over-by-Over ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.over-summary-card {
    background: #ffffff;
    border: 1px solid #eee;
    border-radius: 2px;
    margin-bottom: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    overflow: hidden; /* Fix for border radius */
}
.over-summary-header {
    padding: 4px 10px; /* Reduced padding */
    background: #f8f9fa;
    border-bottom: 1px solid #eee;
}
.over-summary-header h4 {
    margin: 0;
    font-size: 12px; /* Made smaller */
    color: var(--primary-dark-color);
}
.over-summary-balls {
    display: flex;
    flex-wrap: wrap;
    gap: 3px; /* Adjusted gap for round shape */
    padding: 8px; /* Reduced padding */
}
/* Overriding ball-event for this specific screen */
.over-summary-balls .ball-event {
    width: 24px;      /* Fixed width for circle */
    height: 24px;     /* Fixed height for circle */
    border-radius: 50%; /* Make it round */
    font-size: 10px;    /* Adjusted font size */
    flex-grow: 0;       /* Removed flex-grow to maintain shape */
}
/* --- *** ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∂‡ßá‡¶∑ *** --- */

        /* --- Teams & Tournament Style Enhancements --- */
        #teams-list-screen .card h3 {
            color: var(--primary-dark-color);
        }
        #teams-list-screen .card {
            border-left: 4px solid var(--primary-color);
            transition: all 0.25s ease-in-out;
        }
        #teams-list-screen .card:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        #tournament-screen .card h3 {
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-dark-color);
            margin-bottom: 20px;
        }
        #tournament-screen .add-btn {
            background-color: #eaf5fc;
            border: 1px dashed var(--primary-color);
            transition: background-color 0.2s ease;
        }
        #tournament-screen .add-btn:hover {
            background-color: #d6eaf8;
        }
        #tournament-screen .form-group input:focus,
        #tournament-screen .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        #tournament-nav .nav-item {
            padding: 4px 0;
            position: relative;
        }
        /* ‡¶∏‡ßç‡¶ï‡ßã‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá‡¶∞ h2 (score) ‡¶ï‡ßá ‡¶´‡ßç‡¶≤‡ßá‡¶ï‡ßç‡¶∏-‡¶¨‡¶ï‡ßç‡¶∏ ‡¶¨‡¶æ‡¶®‡¶æ‡¶ö‡ßç‡¶õ‡¶ø */
        .scoreboard h2 {
        display: flex;
        justify-content: space-between; /* ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶¶‡ßÅ‡¶á ‡¶™‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§‡ßá ‡¶†‡ßá‡¶≤‡ßá ‡¶¶‡ßá‡¶¨‡ßá */
        align-items: center; /* ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶â‡¶≤‡ßç‡¶≤‡¶Æ‡ßç‡¶¨‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá */
        width: 100%; /* h2 ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó‡¶ï‡ßá ‡¶™‡ßÅ‡¶∞‡ßã ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶¶‡ßá‡¶¨‡ßá */
        position: relative; /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶¨‡¶∏‡ßã‡¶≤‡¶ø‡¶â‡¶ü ‡¶™‡¶ú‡¶ø‡¶∂‡¶®‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        }
        .team-abbr-box {
¬† ¬† background-color: var(--warning-color); /* <-- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶ï‡¶Æ‡¶≤‡¶æ) */
¬† ¬† color: #333; /* <-- ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶ï‡¶æ‡¶≤‡ßã/‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶ó‡ßç‡¶∞‡ßá) */
¬† ¬† padding: 6px 12px;
¬† ¬† border-radius: 8px;
¬† ¬† font-size: 24px; 
¬† ¬† font-weight: 700;
¬† ¬† line-height: 2;
}
        .scoreboard h2 .score-display {
            position: absolute;
            left: 50%;
            transform: translateX(-50%); /* ‡¶∏‡ßç‡¶ï‡ßã‡¶∞‡¶ï‡ßá ‡¶†‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            white-space: nowrap; /* ‡¶õ‡ßã‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶Ø‡ßá‡¶® ‡¶®‡¶æ ‡¶≠‡¶æ‡¶ô‡ßá */
        }
        #tournament-nav .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 0 0 4px 4px;
        }
        .points-table th {
            background-color: #d6eaf8; /* Light primary color */
            color: var(--primary-dark-color);
            font-size: 14px;
        }
        .result-match-item {
            background-color: #fafafa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .summary-input:focus, .date-time-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        .date-time-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--divider-color);
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            background-color: #fdfdfd;
        }


        /* --- Player list Style Enhancements --- */
        #team-details-content .card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 8px;
        }
        .player-row {
            background: #ffffff;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.07);
            padding: 10px 15px;
            border: none;
            border-left: 5px solid var(--accent-color);
        }
        .player-row:last-child {
            margin-bottom: 0;
        }
        .player-row span {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary-color);
            display: flex;
            align-items: center;
        }
        .player-row span::before {
            content: 'person';
            font-family: 'Material Icons';
            margin-right: 12px;
            color: var(--primary-color);
            font-size: 22px;
        }
        .player-row:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left-color: var(--primary-color);
            background-color: #fff;
        }

        /* --- Tournament Save Button Fix --- */
        #tournament-save-btn-container {
            position: fixed;
            bottom: 80px; /* Adjust to be above bottom nav */
            right: 20px;
            z-index: 200;
            display: none; /* Controlled by JS */
            height: 56px;
            width: 56px;
        }
        #tournament-save-btn-container .fab {
            position: absolute; /* Relative to the container */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark-color));
        }

        /* --- *** ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°: Modal Header ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ *** --- */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-header h1 {
            margin: 0;
            flex-grow: 1;
        }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <h2>Admin Login</h2>
            <div class="form-group">
                <label for="login-email-input">Email</label>
                <input type="email" id="login-email-input" value="jahid2177@gmail.com">
            </div>
            <div class="form-group">
                <label for="login-password-input">Password</label>
                <input type="password" id="login-password-input" placeholder="Enter Password">
            </div>
            <button class="btn" id="login-btn">Login</button>
        </div>
    </div>
    <div id="app-container" style="display: none;">
        <div id="new-match-screen" class="screen active">
            <header class="app-header">
                <h1 style="flex-grow: 1; text-align: left; padding-left: 16px;">New Match</h1>
                <button class="icon-button" onclick="handleRefresh()"><span class="material-icons" aria-hidden="true">refresh</span></button>
            </header>
            <main class="content">
                <div class="card">
                    <h2>Teams</h2>
                    <div class="form-group">
                        <label>Team A Name</label>
                        <div class="input-with-dropdown">
                            <input type="text" id="teamA-input" placeholder="Enter Team A Name">
                            <button class="icon-button" onclick="openTeamSelectModal('A')"><span class="material-icons" aria-hidden="true">arrow_drop_down</span></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Team B Name</label>
                        <div class="input-with-dropdown">
                            <input type="text" id="teamB-input" placeholder="Enter Team B Name">
                            <button class="icon-button" onclick="openTeamSelectModal('B')"><span class="material-icons" aria-hidden="true">arrow_drop_down</span></button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="form-group"><label>Toss win by?</label><select id="toss-winner-select"></select></div>
                    <div class="form-group"><label>Opted to?</label><div class="radio-group"><label><input type="radio" name="opted-to" value="bat" checked> Bat</label><label><input type="radio" name="opted-to" value="ball"> Ball</label></div></div>
                    <div class="form-group"><label>Overs</label><input type="number" id="overs-input" placeholder="e.g. 10"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="navigate('advanced-settings-screen')">Advance Setting</button>
                    <button class="btn" onclick="startNewMatch()">Start Match</button>
                </div>
            </main>
            <footer class="bottom-nav">
                <div class="nav-item active" data-screen="new-match-screen"><span class="material-icons" aria-hidden="true">add_circle</span><span>New Match</span></div>
                <div class="nav-item" data-screen="teams-list-screen"><span class="material-icons" aria-hidden="true">group</span><span>Teams</span></div>
                <div class="nav-item" data-screen="tournament-screen"><span class="material-icons" aria-hidden="true">emoji_events</span><span>Tournament</span></div>
                <div class="nav-item" data-screen="history-screen"><span class="material-icons" aria-hidden="true">history</span><span>History</span></div>
            </footer>
        </div>

        <div id="advanced-settings-screen" class="screen">
            <header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1>Match Setting</h1></header>
            <main class="content">
                <div class="card"><div class="form-group"><label>Player per team</label><input type="number" id="players-per-team-input" value="11"></div></div>
                <div class="card">
                    <div class="setting-row"><span>No Ball</span><label class="switch"><input type="checkbox" id="nb-main-toggle" checked><span class="slider"></span></label></div>
                    <div class="setting-row"><span>Re-ball</span><label class="switch"><input type="checkbox" id="nb-reball-toggle" checked><span class="slider"></span></label></div>
                    <div class="setting-row"><span>No Ball Run</span><input type="number" id="nb-run-input" value="1"></div>
                </div>
                <div class="card">
                    <div class="setting-row"><span>Wide Ball</span><label class="switch"><input type="checkbox" id="wd-main-toggle" checked><span class="slider"></span></label></div>
                    <div class="setting-row"><span>Re-ball</span><label class="switch"><input type="checkbox" id="wd-reball-toggle" checked><span class="slider"></span></label></div>
                    <div class="setting-row"><span>Wide Ball Run</span><input type="number" id="wd-run-input" value="1"></div>
                </div>
                <button class="btn" onclick="goBack()">Save Setting</button>
            </main>
        </div>

        <div id="select-opening-players-screen" class="screen">
            <header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1 id="select-players-header">Select Players</h1></header>
            <main class="content">
                <div class="card">
                    <div class="form-group">
                        <label>Striker</label>
                        <div id="striker-container"></div>
                    </div>
                    <div class="form-group">
                        <label>Non-Striker</label>
                        <div id="non-striker-container"></div>
                    </div>
                    <div class="form-group">
                        <label>Opening Bowler</label>
                        <div id="opening-bowler-container"></div>
                    </div>
                </div>
                <button id="start-innings-btn" class="btn" onclick="confirmOpeningPlayers()">1st Innings Start</button>
            </main>
        </div>

        <div id="scorecard-screen" class="screen">
            <header class="app-header">
                <h1 id="scorecard-header-teams"></h1>
                <button class="icon-button" id="full-scorecard-btn"><span style="font-size:24px;">üèè</span></button>
            </header>
            <main class="content">
                <div class="scoreboard card"><h2 id="scoreboard-main"></h2><p id="scoreboard-details"></p></div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="score-table">
                            <thead><tr><th>BATSŒúŒëŒù</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
                            <tbody id="batsman-table"></tbody>
                        </table>
                    </div>
                    <div class="table-responsive">
                         <table class="score-table">
                            <thead><tr><th>BOWLER</th><th>O</th><th>M</th><th>R</th><th>W</th><th>ER</th></tr></thead>
                            <tbody id="bowler-table"></tbody>
                        </table>
                    </div>
                    <div><strong class="this-over">This Over:</strong> <span id="this-over-display"></span></div>
                </div>
                <div class="scoring-controls">
                    <button id="wd-btn" class="btn" onclick="handleExtra('wd')">Wd</button>
                    <button id="nb-btn" class="btn" onclick="handleExtra('nb')">Nb</button>
                    <button id="byes-btn" class="btn" onclick="handleExtra('byes')">Byes</button>
                    <button id="lb-btn" class="btn" onclick="handleExtra('lb')">Lb</button>
                    <button class="btn" style="background: var(--danger-color);" onclick="handleWicket()">Wicket</button>
                    <button class="btn" onclick="handleRetire()">Retire</button>
                    <button class="btn" onclick="swapBatsmen(true)">Swap</button>
                    <button class="btn" onclick="undoLastAction()">Undo</button>
                </div>
                 <div class="run-buttons">
                    <button class="btn" onclick="handleRun(0)">0</button><button class="btn" onclick="handleRun(1)">1</button>
                    <button class="btn" onclick="handleRun(2)">2</button><button class="btn" onclick="handleRun(3)">3</button>
                    <button class="btn" onclick="handleRun(4)">4</button><button class="btn" onclick="handleRun(5)">5</button>
                    <button class="btn" onclick="handleRun(6)">6</button>
                    <button class="btn btn-secondary" onclick="showModal('penalty-run-modal')">...</button>
                </div>
                <div class="btn-group">
                     <button class="btn btn-secondary" onclick="showPartnership()">Partnership</button>
                     <button class="btn btn-secondary" onclick="showExtras()">Extras</button>
                </div>
                <div class="btn-group" style="justify-content: flex-start;">
                    <button id="new-over-btn" class="btn" onclick="forceNewOver()" style="flex-grow: 0; width: auto; min-width: 120px;">New Over</button>
                    <button id="start-second-innings-btn" class="btn" onclick="showSecondInningsPlayersScreen()" style="flex-grow: 0; width: auto; min-width: 150px; display: none; background: var(--accent-color);">Start 2nd Innings</button>
                </div>
            </main>
            <button id="new-match-from-scorecard-btn" class="btn" onclick="resetToNewMatch()">New Match</button>
        </div>

        <div id="match-summary-screen" class="screen">
            <header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1>Full Scorecard</h1></header>
            <main class="content" id="summary-content-wrapper"><div id="summary-content"></div></main>
            <div class="btn-group" style="padding: 0 16px 16px 16px;">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button class="btn btn-secondary" id="download-pdf-btn">Download PDF</button>
            ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button class="btn" id="show-overs-btn">Overs</button>
¬† ¬† ¬† ¬† ¬† ¬† </div>
            </div>

            <div id="overs-details-screen" class="screen">
¬† ¬† ¬† ¬† ¬† ¬† <header class="app-header">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <h1>Over by Over</h1>
¬† ¬† ¬† ¬† ¬† ¬† </header>
¬† ¬† ¬† ¬† ¬† ¬† <main class="content" id="overs-details-content"></main>
¬† ¬† ¬† ¬† </div>

        <div id="teams-list-screen" class="screen"><header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1>Teams</h1></header><main class="content" id="teams-list-content"></main><div class="fab" onclick="showModal('create-team-modal')"><span class="material-icons" aria-hidden="true">add</span></div></div>
        <div id="team-details-screen" class="screen"><header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1 id="team-details-header"></h1></header><main class="content" id="team-details-content"></main><div class="fab" id="add-player-fab" onclick=""><span class="material-icons" aria-hidden="true">person_add</span></div></div>
        <div id="player-stats-screen" class="screen"><header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1 id="player-name-header"></h1></header><main id="player-stats-content"></main></div>
        <div id="tournament-screen" class="screen">
            <header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1>Tournament</h1></header>
            <main class="content" id="tournament-content-wrapper"></main>
             <div id="tournament-save-btn-container">
                <button class="fab" onclick="saveData()"><span class="material-icons" aria-hidden="true">save</span></button>
             </div>
            <footer class="bottom-nav" id="tournament-nav">
                <div class="nav-item active" data-tab="fixtures"><span class="material-icons" aria-hidden="true">view_list</span><span>Fixtures</span></div>
                <div class="nav-item" data-tab="points"><span class="material-icons" aria-hidden="true">leaderboard</span><span>Points</span></div>
                <div class="nav-item" data-tab="results"><span class="material-icons" aria-hidden="true">done_all</span><span>Result</span></div>
            </footer>
        </div>
        <div id="history-screen" class="screen"><header class="app-header"><button class="icon-button" onclick="goBack()"><span class="material-icons" aria-hidden="true">arrow_back</span></button><h1>History</h1></header><main class="content" id="history-content"></main></div>

        <div id="innings-break-modal" class="modal-overlay"><div class="modal-content" style="text-align: center;"><h1 id="innings-break-header">1st Innings End</h1><p id="innings-break-target"></p><div class="btn-group"><button class="btn" onclick="showSecondInningsPlayersScreen()">Start 2nd Innings</button></div></div></div>
        <div id="create-team-modal" class="modal-overlay"><div class="modal-content"><h1>Create Team</h1><div class="form-group"><label>Team Name</label><input type="text" id="new-team-name-input"></div><div class="btn-group"><button class="btn btn-secondary" onclick="closeModal('create-team-modal')">Cancel</button><button class="btn" onclick="createTeam()">OK</button></div></div></div>
        <div id="add-player-modal" class="modal-overlay"><div class="modal-content"><h1>Add Player</h1><div class="form-group"><label>Player Name</label><input type="text" id="new-player-name-input"></div><button class="btn" onclick="addPlayer()">Save</button></div></div>
        
        <div id="fall-of-wicket-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h1>Fall of Wicket</h1>
                    <button class="icon-button" onclick="closeModal('fall-of-wicket-modal')" style="color: var(--text-secondary-color);"><span class="material-icons" aria-hidden="true">close</span></button>
                </div>
                <div class="form-group">
                    <label>How wicket fall?</label>
                    <select id="wicket-type" onchange="toggleRunOutRuns(this.value)">
                        <option>Bowled</option>
                        <option>Catch Out</option>
                        <option>Run out striker</option>
                        <option>Run out Non-striker</option>
                        <option>Stumping</option>
                        <option>LBW</option>
                        <option>Hit wicket</option>
                    </select>
                </div>
                <div class="form-group" id="run-out-runs-group" style="display: none;">
                    <label>Runs completed before run-out?</label>
                    <input type="number" id="run-out-runs-input" value="0" min="0" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label>New Batsman</label>
                    <div id="new-batsman-container-wicket">
                        <input type="text" id="new-batsman-input-wicket" placeholder="Enter new batsman name">
                    </div>
                </div>
                <button class="btn" onclick="confirmNewBatsman('wicket')">Done</button>
            </div>
        </div>
        
        <div id="retire-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h1>New Batsman</h1>
                    <button class="icon-button" onclick="closeModal('retire-modal')" style="color: var(--text-secondary-color);"><span class="material-icons" aria-hidden="true">close</span></button>
                </div>
                <div class="form-group">
                    <label>New Batsman Name</label>
                    <div id="new-batsman-container-retire">
                        <input type="text" id="new-batsman-input-retire" placeholder="Enter new batsman name">
                    </div>
                </div>
                <button class="btn" onclick="confirmNewBatsman('retire')">Done</button>
            </div>
        </div>

        <div id="choose-bowler-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h1>Choose New Bowler</h1>
                    <button class="icon-button" onclick="closeModal('choose-bowler-modal')" style="color: var(--text-secondary-color);"><span class="material-icons" aria-hidden="true">close</span></button>
                </div>
                <div class="form-group">
                    <label>Select a new bowler</label>
                    <div id="new-bowler-container">
                        <input type="text" id="new-bowler-input">
                    </div>
                </div>
                <button class="btn" onclick="confirmNewBowler()">Done</button>
            </div>
        </div>
        <div id="penalty-run-modal" class="modal-overlay"><div class="modal-content"><h3>Penalty Run</h3><div class="form-group"><input type="number" id="penalty-run-input" placeholder="Enter runs"></div><div class="btn-group"><button class="btn btn-secondary" onclick="closeModal('penalty-run-modal')">Cancel</button><button class="btn" onclick="addPenaltyRuns()">OK</button></div></div></div>
        <div id="toast-notification" class="toast"></div>
        <div id="confirmation-modal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="confirmation-modal-title">Are you sure?</h3>
                <p id="confirmation-modal-message"></p>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="confirmation-modal-cancel">Cancel</button>
                    <button class="btn" style="background: var(--danger-color);" id="confirmation-modal-confirm">Confirm</button>
                </div>
            </div>
        </div>

        <div id="team-select-modal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="team-select-modal-title">Select Team</h3>
                <div id="team-select-modal-list"></div>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyCV2XwcArssrHcgeGSruUGmU524ceSLwRk",
      authDomain: "cricketcc.firebaseapp.com",
      projectId: "cricketcc",
      storageBucket: "cricketcc.firebasestorage.app",
      messagingSenderId: "1067596696661",
      appId: "1:1067596696661:web:e0b7943b002f075b7858dc"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;


    // --- GLOBAL APP STATE & LOGIC ---
    let navigationStack = ['new-match-screen'];
    let matchState = {};
    let appData = { teams: [], history: [] };
    let history = []; // for undo
    let tournamentState = {};

    // --- INITIALIZATION & DATA HANDLING ---
    function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }

    function getInitialState() {
        return {
            id: generateUniqueId(),
            teamA_id: null, teamB_id: null,
            battingTeamObject: null, bowlingTeamObject: null,
            completionDate: null, toss: '',
            settings: { totalOvers: 5, playersPerTeam: 11, wd: { reball: true, runs: 1 }, nb: { reball: true, runs: 1 } },
            innings: {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 1: { team: '', score: 0, wickets: 0, balls: 0, extras: { total: 0, wd: 0, nb: 0, byes: 0, lb: 0 }, allBatsmen: [], allBowlers: [], fallOfWickets: [], allOvers: [] },
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 2: { team: '', score: 0, wickets: 0, balls: 0, extras: { total: 0, wd: 0, nb: 0, byes: 0, lb: 0 }, allBatsmen: [], allBowlers: [], fallOfWickets: [], allOvers: [] }
¬† ¬† ¬† ¬† ¬† ¬† },
            currentInnings: 1, battingTeam: '', bowlingTeam: '',
            batsmen: [], currentPartnership: { runs: 0, balls: 0, batsmen: [] },
            bowlers: [], currentBowlerId: null,
            thisOver: [], isOverComplete: false, pendingRun: null,
            result: ''
        };
    }

    // --- NAVIGATION & UI UTILS ---
    function navigate(screenId) {
        const currentScreenId = navigationStack[navigationStack.length - 1];
        if (currentScreenId === screenId) return;
        if (currentScreenId) {
            const currentScreen = document.getElementById(currentScreenId);
            currentScreen.classList.remove('active');
            currentScreen.classList.add('inactive-left');
        }
        const screenElement = document.getElementById(screenId);
        screenElement.classList.remove('inactive-left');
        screenElement.classList.add('active');
        navigationStack.push(screenId);
    }

    function goBack() {
        if (navigationStack.length <= 1) return;
        const currentScreenId = navigationStack.pop();
        const prevScreenId = navigationStack[navigationStack.length - 1];
        document.getElementById(currentScreenId)?.classList.remove('active');
        const prevScreen = document.getElementById(prevScreenId);
        prevScreen?.classList.remove('inactive-left');
        prevScreen?.classList.add('active');
    }

    function resetToNewMatch() {
        matchState = getInitialState();
        history = [];
        localStorage.removeItem('inProgressMatch'); // Clear in-progress match on reset
        document.getElementById('teamA-input').value = '';
        document.getElementById('teamB-input').value = '';
        document.getElementById('overs-input').value = '';
        navigationStack = ['new-match-screen'];
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active', 'inactive-left'));
        document.getElementById('new-match-screen').classList.add('active');
        document.getElementById('new-match-from-scorecard-btn').style.display = 'none';

        document.querySelectorAll('.bottom-nav .nav-item').forEach(item => item.classList.remove('active'));
        const newMatchNavItem = document.querySelector('.bottom-nav .nav-item[data-screen="new-match-screen"]');
        if (newMatchNavItem) newMatchNavItem.classList.add('active');

        // ** ADDED: Publish empty state to viewers **
        publishPublicData();
    }

    function navigateReplace(newScreenId) {
        if (navigationStack.length > 0) {
            const currentScreenId = navigationStack.pop();
            if (currentScreenId) document.getElementById(currentScreenId)?.classList.remove('active', 'inactive-left');
        }
        const newScreenElement = document.getElementById(newScreenId);
        newScreenElement.classList.remove('inactive-left');
        newScreenElement.classList.add('active');
        navigationStack.push(newScreenId);
    }

    document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const screenId = item.dataset.screen;
            if(!screenId) return;
            navigationStack = ['new-match-screen'];
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active', 'inactive-left'));
            document.getElementById('new-match-screen').classList.add('active');
            if (screenId !== 'new-match-screen') navigate(screenId);
            document.querySelectorAll('.bottom-nav .nav-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            if (screenId === 'teams-list-screen') renderTeamsList();
            if (screenId === 'history-screen') renderHistoryList();
            if (screenId === 'tournament-screen') renderTournamentFixtures();
        });
    });

    function showModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message; toast.style.opacity = 1; toast.style.transform = 'translateX(-50%) translateY(0)';
        setTimeout(() => { toast.style.opacity = 0; toast.style.transform = 'translateX(-50%) translateY(20px)'; }, 2500);
    }

    function showConfirmationModal(message, onConfirm, onCancel = () => {}) {
        document.getElementById('confirmation-modal-message').textContent = message;
        const confirmBtn = document.getElementById('confirmation-modal-confirm');
        const cancelBtn = document.getElementById('confirmation-modal-cancel');
        const confirmHandler = () => { onConfirm(); cleanup(); };
        const cancelHandler = () => { onCancel(); cleanup(); };
        const cleanup = () => {
            closeModal('confirmation-modal');
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };
        confirmBtn.addEventListener('click', confirmHandler, { once: true });
        cancelBtn.addEventListener('click', cancelHandler, { once: true });
        showModal('confirmation-modal');
    }

    // --- ** NEW FUNCTION TO PUBLISH DATA FOR VIEWERS ** ---
    async function publishPublicData() {
        if (!db) return; // Ensure Firebase is initialized
        const publicDataRef = db.collection("publicData").doc("liveScoreData");

        try {
            await publicDataRef.set({
                appData: appData,
                tournamentState: tournamentState,
                liveMatchState: matchState // The current state of the match
            });
            console.log("Public data published successfully.");
        } catch (error) {
            console.error("Error publishing public data: ", error);
            // Do not show toast for every minor failure to avoid spamming the admin
        }
    }

    // --- Data Persistence (Firebase & Local Storage) ---
    function saveAppDataToLocal() { try { localStorage.setItem('cricketAppData', JSON.stringify(appData)); } catch (e) { console.error("Error saving app data to local", e); }}
    
// --- MODIFIED FUNCTION ---
    function loadAppDataFromLocal() {
        try {
            // --- DATA PRE-POPULATION (TEAMS) ---
            const defaultAppData = {
                teams: [
                    { id: generateUniqueId(), name: "Corporate Credit", players: [
                    { id: generateUniqueId(), name: "MD. SHAHIN MIAH", stats: {} },
                    { id: generateUniqueId(), name: "A.K.M. ABDUR RAUF", stats: {} },
                    { id: generateUniqueId(), name: "MD. SOHEL RANA", stats: {} },
                    { id: generateUniqueId(), name: "A.T.M. MASUDUR RAHMAN", stats: {} },
                    { id: generateUniqueId(), name: "MD.AL-AMIN PRODHAN", stats: {} },
                    { id: generateUniqueId(), name: "KAMAL HOSSAIN", stats: {} },
                    { id: generateUniqueId(), name: "MD. RUHUL AMIN", stats: {} },
                    { id: generateUniqueId(), name: "MD. SHAMSUL ARAFIN", stats: {} },
                    { id: generateUniqueId(), name: "SAIF UDDIN AHMED", stats: {} },
                    { id: generateUniqueId(), name: "MAMUN OR RASHID", stats: {} },
                    { id: generateUniqueId(), name: "BIPUL SARKER", stats: {} },
                    { id: generateUniqueId(), name: "MD. SOHEL RANA", stats: {} },
                    { id: generateUniqueId(), name: "SAIFUDDIN AL-MAMUN", stats: {} },
                    { id: generateUniqueId(), name: "Humayun Azad Rubel", stats: {} },
                    { id: generateUniqueId(), name: "MD. RAKIB HASAN", stats: {} },
                    ] },
                    { id: generateUniqueId(), name: "Card Operation", players: [
                    { id: generateUniqueId(), name: "Md.Rakibul Islam (C)", stats: {} },
                    { id: generateUniqueId(), name: "Md. Aminul Islam", stats: {} },
                    { id: generateUniqueId(), name: "Md kayum Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Md. Selim Reza", stats: {} },
                    { id: generateUniqueId(), name: "Md sherin kabir", stats: {} },
                    { id: generateUniqueId(), name: "Md.Zahid hasan", stats: {} },
                    { id: generateUniqueId(), name: "Md.Rashedul hassan", stats: {} },
                    { id: generateUniqueId(), name: "Mithu nath", stats: {} },
                    { id: generateUniqueId(), name: "Motahar Hossan", stats: {} },
                    { id: generateUniqueId(), name: "Sujan Chandra biswas", stats: {} },
                    { id: generateUniqueId(), name: "Md Robiul Islam", stats: {} },
                    { id: generateUniqueId(), name: "Abdur Rahim", stats: {} },
                    { id: generateUniqueId(), name: "Md Mishbah Uddin", stats: {} },
                    { id: generateUniqueId(), name: "Haowlader", stats: {} },
                    { id: generateUniqueId(), name: "Md salim Molla", stats: {} }
                    ] },
                    { id: generateUniqueId(), name: "ICT Operation", players: [
                    { id: generateUniqueId(), name: "Wasim Akram", stats: {} },
                    { id: generateUniqueId(), name: "Md. Shamim Hosan", stats: {} },
                    { id: generateUniqueId(), name: "Md. Shariful Molla", stats: {} },
                    { id: generateUniqueId(), name: "Md. Morsalin Islam", stats: {} },
                    { id: generateUniqueId(), name: "Zobair Hossen", stats: {} },
                    { id: generateUniqueId(), name: "Md. Rafiqul Islam", stats: {} },
                    { id: generateUniqueId(), name: "Jashim Uddin Bhuiyan", stats: {} },
                    { id: generateUniqueId(), name: "Md. Shah Alam", stats: {} },
                    { id: generateUniqueId(), name: "Md Taimum Islam", stats: {} },
                    { id: generateUniqueId(), name: "Rahul Das", stats: {} },
                    { id: generateUniqueId(), name: "Md. Pias Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Md. A. Bari", stats: {} },
                    { id: generateUniqueId(), name: "Md. Rofiqul Islam Saim", stats: {} },
                    { id: generateUniqueId(), name: "Md. Khalekul Islam Ripon", stats: {} },
                    { id: generateUniqueId(), name: "Md. Imran Ali", stats: {} },
                    ] },
                    { id: generateUniqueId(), name: "Dhaka South Zone", players: [
                    { id: generateUniqueId(), name: "MD. SAMSUL ALAM", stats: {} },
                    { id: generateUniqueId(), name: "MD.AZIM MIA", stats: {} },
                    { id: generateUniqueId(), name: "NAFIZ BIN YOUNUS", stats: {} },
                    { id: generateUniqueId(), name: "Lingkon", stats: {} },
                    { id: generateUniqueId(), name: "MD.MANJURUL ISLAM", stats: {} },
                    { id: generateUniqueId(), name: "ARKO KUMAR", stats: {} },
                    { id: generateUniqueId(), name: "M.I.Monir", stats: {} },
                    { id: generateUniqueId(), name: "RUPOM", stats: {} },
                    { id: generateUniqueId(), name: "SUDHIR KUMAR SARKAR", stats: {} },
                    { id: generateUniqueId(), name: "ZAKI AZAD KHAN", stats: {} },
                    { id: generateUniqueId(), name: "MD.MAMUNUR RASHID", stats: {} },
                    { id: generateUniqueId(), name: "KAZI MD ALAUDDIN", stats: {} },
                    { id: generateUniqueId(), name: "MD.KOWSAR MIAH", stats: {} },
                    { id: generateUniqueId(), name: "REFAT ISLAM ONIK", stats: {} },
                    ] },
                    { id: generateUniqueId(), name: "Narayangonj Zone", players: [
                    { id: generateUniqueId(), name: "MASUM REZA", stats: {} },
                    { id: generateUniqueId(), name: "MD ATIQUL ISLAM", stats: {} },
                    { id: generateUniqueId(), name: "ATIQUL ISLAM SUJAN", stats: {} },
                    { id: generateUniqueId(), name: "MAMUN KAZI", stats: {} },
                    { id: generateUniqueId(), name: "SHAHIDUL ISLAM", stats: {} },
                    { id: generateUniqueId(), name: "SUMIT DATTA", stats: {} },
                    { id: generateUniqueId(), name: "PRADIP HALDER", stats: {} },
                    { id: generateUniqueId(), name: "MD SEAM ISLAM", stats: {} },
                    { id: generateUniqueId(), name: "A T M WAZED", stats: {} },
                    { id: generateUniqueId(), name: "MEHEDI HASAN", stats: {} },
                    { id: generateUniqueId(), name: "ALAMGIR HOSIEN", stats: {} },
                    { id: generateUniqueId(), name: "ABDULLHA-AL-MAMUN", stats: {} },
                    { id: generateUniqueId(), name: "SABBIR AHMMED", stats: {} },
                    { id: generateUniqueId(), name: "MD. RAKIBUL ISLAM", stats: {} },
                    { id: generateUniqueId(), name: "Yeasin", stats: {} },
                    { id: generateUniqueId(), name: "MD. RASHIDUL ISLAM", stats: {} },
                    ] },
                    { id: generateUniqueId(), name: "Dhaka Central Zone", players: [
                    { id: generateUniqueId(), name: "Sagar Biswas", stats: {} },
                    { id: generateUniqueId(), name: "Md. Mahmudul Haque (c)", stats: {} },
                    { id: generateUniqueId(), name: "Md. Kamruzzaman", stats: {} },
                    { id: generateUniqueId(), name: "Sahidul Islam", stats: {} },
                    { id: generateUniqueId(), name: "Arif Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Abdul Aziz Chowdhury",stats: {} },
                    { id: generateUniqueId(), name: "Md. Azizul Hakim", stats: {} },
                    { id: generateUniqueId(), name: "Md. Imran Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Shahadat Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Mostak Ahmed", stats: {} },
                    { id: generateUniqueId(), name: "Md. Rafayet Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Soleman Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Nikunjo", stats: {} },
                    { id: generateUniqueId(), name: "Robiul", stats: {} },
                    { id: generateUniqueId(), name: "Md. Zihad Hossainn", stats: {} },
                    ] },
                    { id: generateUniqueId(), name: "Treasury", players: [
                    { id: generateUniqueId(), name: "Md Mominul Islam (C)", stats: {} },
                    { id: generateUniqueId(), name: "Saleh Ahamed", stats: {} },
                    { id: generateUniqueId(), name: "Delowar Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Obaidullah", stats: {} },
                    { id: generateUniqueId(), name: "Abdullya Faruq", stats: {} },
                    { id: generateUniqueId(), name: "Md Razu Ahmed", stats: {} },
                    { id: generateUniqueId(), name: "Md. Motaleb Sardar", stats: {} },
                    { id: generateUniqueId(), name: "Md. Deloyar Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Nasir uddin", stats: {} },
                    { id: generateUniqueId(), name: "Jamaluddin Ahmed", stats: {} },
                    { id: generateUniqueId(), name: "Md. Saiful Alam", stats: {} },
                    { id: generateUniqueId(), name: "Mahbub Alam", stats: {} },
                    { id: generateUniqueId(), name: "Mahbub Alam", stats: {} },
                    { id: generateUniqueId(), name: "Mohammad Ali Miah", stats: {} },
                    { id: generateUniqueId(), name: "Mohammad Mainur Rahman", stats: {} }
                    ] },
                    { id: generateUniqueId(), name: "Card Business", players: [
                    { id: generateUniqueId(), name: "N. M Feroz Kamal", stats: {} },
                    { id: generateUniqueId(), name: "Zihad Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Md Jahidul Islam", stats: {} },
                    { id: generateUniqueId(), name: "Md Belal Suman", stats: {} },
                    { id: generateUniqueId(), name: "Md Mamun Pervez", stats: {} },
                    { id: generateUniqueId(), name: "Hridoy Chakroborty", stats: {} },
                    { id: generateUniqueId(), name: "Asraf Uddin", stats: {} },
                    { id: generateUniqueId(), name: "Imran Shahriyar", stats: {} },
                    { id: generateUniqueId(), name: "Assaduz Zaman", stats: {} },
                    { id: generateUniqueId(), name: "Md. Jahidul Haque", stats: {} },
                    { id: generateUniqueId(), name: "MD. SAMIUL HAQUE", stats: {} },
                    { id: generateUniqueId(), name: "Md.Kajal Sheikh", stats: {} },
                    { id: generateUniqueId(), name: "Prodip Chandra Banik", stats: {} },
                    { id: generateUniqueId(), name: "J A Pranto", stats: {} },
                    { id: generateUniqueId(), name: "MD. Ibnul Hasan", stats: {} }
                     ] },
                    { id: generateUniqueId(), name: "CAM & RD", players: [
                    { id: generateUniqueId(), name: "Mohammad Matiur Rahman", stats: {} },
                    { id: generateUniqueId(), name: "Md. Taufiq Mahmud(c)", stats: {} },
                    { id: generateUniqueId(), name: "Sujan Kumar kundu", stats: {} },
                    { id: generateUniqueId(), name: "Md. Fazleh Elahi", stats: {} },
                    { id: generateUniqueId(), name: "Md. Abubakar Mollah", stats: {} },
                    { id: generateUniqueId(), name: "Shaikh Syfur Rahman", stats: {} },
                    { id: generateUniqueId(), name: "Md.Habibullah", stats: {} },
                    { id: generateUniqueId(), name: "Uttam Kumar Biswas", stats: {} },
                    { id: generateUniqueId(), name: "Md. Azad Mia", stats: {} },
                    { id: generateUniqueId(), name: "Mohammad Saiful Islam", stats: {} },
                    { id: generateUniqueId(), name: "Kazi Didarul Alam", stats: {} },
                    { id: generateUniqueId(), name: "Md. Amanullah", stats: {} },
                    { id: generateUniqueId(), name: "Md. Maniruzzaman Khan", stats: {} },
                    { id: generateUniqueId(), name: "Rasham Khan", stats: {} },
                    { id: generateUniqueId(), name: "Kausar Alam", stats: {} }
                    ] },
                    { id: generateUniqueId(), name: "ID", players: [ 
                    { id: generateUniqueId(), name: "MD. ALTAB HOSSAIN", stats: {} },
                    { id: generateUniqueId(), name: "MD. AKTARUZZAMAN", stats: {} },
                    { id: generateUniqueId(), name: "MD. JIADUL ISLAM", stats: {} },
                    { id: generateUniqueId(), name: "MD. MUKHLASUR RAHMAN", stats: {} },
                    { id: generateUniqueId(), name: "MD. TARIQUL ISLAM", stats: {} },
                    { id: generateUniqueId(), name: "MD. JAFAR IQBAL", stats: {} },
                    { id: generateUniqueId(), name: "MD. FARUK HOSSAIN", stats: {} },
                    { id: generateUniqueId(), name: "MASUD RANA", stats: {} },
                    { id: generateUniqueId(), name: "MD. MAZEDUR RASHID", stats: {} },
                    { id: generateUniqueId(), name: "MD. RAISUL ALAM", stats: {} },
                    { id: generateUniqueId(), name: "MD.BADRUL ISLAM ", stats: {} },
                    { id: generateUniqueId(), name: "MD. SABBIR NEWAZ", stats: {} },
                    { id: generateUniqueId(), name: "MIR TANVIR AHMED", stats: {} },
                    { id: generateUniqueId(), name: "JOBAYER HOSSAIN", stats: {} },
                    { id: generateUniqueId(), name: "Md. Murshid Alam", stats: {} },
                    { id: generateUniqueId(), name: "MD. SULTANUL ARIFIN", stats: {} },
                    ] },
                    { id: generateUniqueId(), name: "SDD", players: [
                    { id: generateUniqueId(), name: "Rakibul Alam(C)", stats: {} },
                    { id: generateUniqueId(), name: "Roki Billah", stats: {} },
                    { id: generateUniqueId(), name: "Ahasan Adil Arnob", stats: {} },
                    { id: generateUniqueId(), name: "Ahsanur Rabbi Rahat", stats: {} },
                    { id: generateUniqueId(), name: "Md. Abu Sayem", stats: {} },
                    { id: generateUniqueId(), name: "Mizan Sardar", stats: {} },
                    { id: generateUniqueId(), name: "Md. Aminul Islam", stats: {} },
                    { id: generateUniqueId(), name: "Sourav Das", stats: {} },
                    { id: generateUniqueId(), name: "Md. Abu Aiub Ansari", stats: {} },
                    { id: generateUniqueId(), name: "Joy Das", stats: {} },
                    { id: generateUniqueId(), name: "Kazi Akram Uddin", stats: {} },
                    { id: generateUniqueId(), name: "Md. Rakibul Hasan", stats: {} },
                    { id: generateUniqueId(), name: "S.M. Zahidul Islam", stats: {} },
                    { id: generateUniqueId(), name: "Abul Kalam", stats: {} },
                    { id: generateUniqueId(), name: "Md. Alamin Molla", stats: {} }
                    ] },
                    { id: generateUniqueId(), name: "Principal", players: [
                    { id: generateUniqueId(), name: "MD. Abir Hossain (C)", stats: {} },
                    { id: generateUniqueId(), name: "Mukul Kumar Paul", stats: {} },
                    { id: generateUniqueId(), name: "Merajul Hasan Sarker", stats: {} },
                    { id: generateUniqueId(), name: "Chowdhury M-Sums", stats: {} },
                    { id: generateUniqueId(), name: "MD Rakib Mahtab", stats: {} },
                    { id: generateUniqueId(), name: "MD. Tanvir Nabi", stats: {} },
                    { id: generateUniqueId(), name: "MD. Imran Hossain", stats: {} },
                    { id: generateUniqueId(), name: "MD. Noor Hossain", stats: {} },
                    { id: generateUniqueId(), name: "Raqibul Hasan", stats: {} },
                    { id: generateUniqueId(), name: "MD. Rana Kawser", stats: {} },
                    { id: generateUniqueId(), name: "MD. Imran Khan", stats: {} },
                    { id: generateUniqueId(), name: "MD. Al-Amin", stats: {} },
                    { id: generateUniqueId(), name: "MD. Nur Alam", stats: {} },
                    { id: generateUniqueId(), name: "Md. Mujammel", stats: {} },  
                    { id: generateUniqueId(), name: "Mahad Hossain", stats: {} },
                    ] }
                ],
                history: []
            };
            // --- END PRE-POPULATION ---
            appData = JSON.parse(localStorage.getItem('cricketAppData')) || defaultAppData;
        }
        catch (e) { console.error("Error loading app data from local", e); appData = { teams: [], history: [] }; } // Keep original fallback
    }
    // --- END MODIFIED FUNCTION ---

    function saveTournamentDataToLocal() { try { localStorage.setItem('tournamentData', JSON.stringify(tournamentState)); } catch (e) { console.error("Error saving tournament data to local", e); }}
    function loadTournamentDataFromLocal() {
        try {
            const data = localStorage.getItem('tournamentData');
            tournamentState = data ? JSON.parse(data) : {};
            if (!tournamentState.groups || !tournamentState.fixtures) {
                resetTournamentState();
            }
        }
        catch (e) { console.error("Error loading tournament data from local", e); resetTournamentState(); }
    }

    // Combined save function for Firebase and Local Storage
    async function saveData() {
        // Save to local storage first for speed and offline availability
        saveAppDataToLocal();
        saveTournamentDataToLocal();

        if (currentUser) {
            try {
                const userDocRef = db.collection("users").doc(currentUser.uid);
                await userDocRef.set({
                    appData: appData,
                    tournamentState: tournamentState
                });
                console.log("Private data saved to Firebase.");
            } catch (error) {
                console.error("Error saving private data to Firebase: ", error);
                showToast("Could not sync private data.");
            }
        }

        // ** ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá **
        // ‡¶è‡¶ñ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∂‡¶æ‡¶™‡¶æ‡¶∂‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡ßá‡¶ì ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
        await publishPublicData();

        showToast('Data saved and synced!');
    }

    // --- *** NEW FUNCTION FOR REFRESH BUTTON *** ---
    async function handleRefresh() {
        showToast("Refreshing data...");
        await loadData(); // Reloads all data from Firebase
        renderInitialUI(); // Re-renders the current view
        showToast("Data refreshed successfully!");
    }


    // Combined load function
    async function loadData() {
        // 1. Load from local storage first for immediate UI
        loadAppDataFromLocal();
        loadTournamentDataFromLocal();
        console.log("Loaded data from local storage.");

        // 2. Then, fetch from Firebase to get the most up-to-date info
        if (!currentUser) return;

        try {
            const userDocRef = db.collection("users").doc(currentUser.uid);
            const docSnap = await userDocRef.get();

            if (docSnap.exists()) {
                console.log("Firebase data found. Overwriting local data.");
                const firebaseData = docSnap.data();
                appData = firebaseData.appData || { teams: [], history: [] };
                tournamentState = firebaseData.tournamentState || {};
                if (!tournamentState.groups || !tournamentState.fixtures) {
                    resetTournamentState();
                }
                saveAppDataToLocal();
                saveTournamentDataToLocal();
                console.log("Synced Firebase data to local storage.");
            } else {
                console.log("No data in Firebase. Uploading local data if it exists.");
                await saveData(); // This will save the currently loaded local data to Firebase
            }
        } catch (error) {
            console.error("Error loading data from Firebase: ", error);
            showToast("Could not load cloud data.");
        }

        // Finally, render the UI with the definitive data
        renderInitialUI();
    }

    // This function ensures the UI is correctly rendered after all data is loaded
    function renderInitialUI() {
        updateTossOptions();
        const activeScreen = document.querySelector('.screen.active');
        if (activeScreen) {
             if (activeScreen.id === 'teams-list-screen') renderTeamsList();
             if (activeScreen.id === 'history-screen') renderHistoryList();
             if (activeScreen.id === 'tournament-screen') renderTournamentFixtures();
        }
    }

    // *** START: NEW FUNCTION 1 ***
    // Checks if user is already logged in on page load
    function checkAuthState() {
      auth.onAuthStateChanged(async user => {
        if (user) {
          // User is already signed in
          currentUser = user;
          console.log("User already signed in:", currentUser.uid);
          
          document.getElementById('login-overlay').style.display = 'none';
          document.getElementById('app-container').style.display = 'block';
          
          await loadData(); // Load their data
          checkForInProgressMatch();
        } else {
          // User is signed out, do nothing.
          // The login overlay is visible by default.
          console.log("User is signed out.");
        }
      });
    }
    // *** END: NEW FUNCTION 1 ***


    function checkForInProgressMatch() {
        const inProgressMatchData = localStorage.getItem('inProgressMatch');
        if (inProgressMatchData) {
            showConfirmationModal("An unfinished match was found. Would you like to resume it?",
                () => { // onConfirm
                    try {
                        localStorage.removeItem('inProgressMatch'); // Resume ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶á‡¶®-‡¶™‡ßç‡¶∞‡¶ó‡ßç‡¶∞‡ßá‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
                        const loadedMatch = JSON.parse(inProgressMatchData);
                        matchState = loadedMatch;
                        history = [JSON.parse(JSON.stringify(matchState))];
                        renderScorecard();
                        navigate('scorecard-screen');
                        showToast("Match resumed.");
                    } catch (e) {
                        console.error("Failed to parse in-progress match.", e);
                        localStorage.removeItem('inProgressMatch');
                        showToast("Could not resume match, data was corrupted.");
                    }
                },
                () => { // onCancel
                    // User chose not to resume. The match data remains in localStorage
                    // and will be visible in the History tab.
                    showToast("Match not resumed. You can resume it from the History tab.");
                }
            );
        }
    }


    // --- TEAMS & PLAYERS ---
    function renderTeamsList() {
        const content = document.getElementById('teams-list-content');
        content.innerHTML = '';
        if (appData.teams.length === 0) { content.innerHTML = '<div class="card"><p>No teams created. Tap + to add one.</p></div>'; return; }
        appData.teams.forEach(team => {
            const teamCard = document.createElement('div');
            teamCard.className = 'card';
            teamCard.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div onclick="renderTeamDetails('${team.id}'); navigate('team-details-screen');" style="flex-grow: 1; cursor: pointer;">
                        <h3>${team.name}</h3><p style="margin:0; color: var(--text-secondary-color);">${team.players.length} Players</p>
                    </div>
                    <div>
                        <button class="icon-button" style="color: var(--text-secondary-color);" onclick="event.stopPropagation(); editTeamName('${team.id}');"><i class="material-icons">edit</i></button>
                        <button class="icon-button" style="color: var(--danger-color);" onclick="event.stopPropagation(); deleteTeam('${team.id}');"><i class="material-icons">delete</i></button>
                    </div>
                </div>`;
            content.appendChild(teamCard);
        });
    }

    function createTeam() {
        const nameInput = document.getElementById('new-team-name-input'); const name = nameInput.value.trim();
        if (name) { appData.teams.push({ id: generateUniqueId(), name, players: [] }); saveData(); nameInput.value = ''; closeModal('create-team-modal'); renderTeamsList(); }
    }

    function editTeamName(teamId) {
        const team = appData.teams.find(t => t.id === teamId);
        if (!team) return;
        const newName = prompt("Enter new team name:", team.name);
        if (newName && newName.trim() !== "") {
            team.name = newName.trim();
            saveData();
            renderTeamsList();
            showToast("Team name updated.");
        }
    }

    function deleteTeam(teamId) { showConfirmationModal("Are you sure you want to delete this team?", () => { appData.teams = appData.teams.filter(t => t.id !== teamId); saveData(); renderTeamsList(); showToast("Team deleted."); }); }

    function renderTeamDetails(teamId) {
        const team = appData.teams.find(t => t.id === teamId);
        if (!team) { goBack(); return; }
        document.getElementById('team-details-header').innerText = team.name;
        const content = document.getElementById('team-details-content'); content.innerHTML = '<div class="card"></div>';
        const cardContent = content.querySelector('.card');

        if (team.players.length === 0) {
            cardContent.innerHTML = '<p>No players. Tap + to add.</p>';
        } else {
            cardContent.innerHTML = ''; // Clear previous content
            team.players.forEach(player => {
                const playerRow = document.createElement('div'); playerRow.className = 'player-row';
                playerRow.innerHTML = `
                    <span onclick="renderPlayerStats('${player.id}', '${team.id}')">${player.name}</span>
                    <div>
                        <button class="icon-button" style="color: var(--text-secondary-color);" onclick="editPlayerName('${player.id}', '${team.id}')"><i class="material-icons">edit</i></button>
                        <button class="icon-button" style="color: var(--danger-color);" onclick="deletePlayer('${player.id}', '${team.id}')"><i class="material-icons">delete</i></button>
                    </div>`;
                cardContent.appendChild(playerRow);
            });
        }
        document.getElementById('add-player-fab').onclick = () => { document.getElementById('add-player-modal').dataset.teamId = teamId; showModal('add-player-modal'); };
    }

    function addPlayer() {
        const teamId = document.getElementById('add-player-modal').dataset.teamId; const team = appData.teams.find(t => t.id === teamId);
        const nameInput = document.getElementById('new-player-name-input'); const name = nameInput.value.trim();
        if (name && team) { team.players.push({ id: generateUniqueId(), name, stats: {} }); saveData(); nameInput.value = ''; closeModal('add-player-modal'); renderTeamDetails(teamId); }
    }

    function editPlayerName(playerId, teamId) {
        const team = appData.teams.find(t => t.id === teamId); const player = team?.players.find(p => p.id === playerId); if (!player) return;
        const newName = prompt("Enter new name for the player:", player.name);
        if (newName && newName.trim() !== "") { player.name = newName.trim(); saveData(); renderTeamDetails(teamId); showToast("Player name updated."); }
    }

    function deletePlayer(playerId, teamId) { showConfirmationModal("Delete this player?", () => { const team = appData.teams.find(t => t.id === teamId); if (team) { team.players = team.players.filter(p => p.id !== playerId); saveData(); renderTeamDetails(teamId); showToast("Player deleted."); } }); }

    function renderPlayerStats(playerId, teamId) {
        const team = appData.teams.find(t => t.id === teamId); const player = team?.players.find(p => p.id === playerId);
        if (!team || !player) { showToast("Player not found!"); goBack(); return; }
        navigate('player-stats-screen');
        document.getElementById('player-name-header').innerText = player.name;
        const content = document.getElementById('player-stats-content');
        content.innerHTML = `
            <div class="player-profile-header"><div class="player-profile-pic"><i class="material-icons" style="font-size: 50px; color: white;">person</i></div><h2>${player.name}</h2><p>${team.name}</p></div>
            <div class="bottom-nav player-stats-tabs">
                <div id="batting-tab" class="nav-item active" onclick="switchPlayerTab('batting', '${playerId}', '${teamId}')"><i class="material-icons">sports_cricket</i><span>Batting</span></div>
                <div id="bowling-tab" class="nav-item" onclick="switchPlayerTab('bowling', '${playerId}', '${teamId}')"><i class="material-icons">sports</i><span>Bowling</span></div>
            </div>
            <div class="content" id="player-stats-container"></div>`;
        switchPlayerTab('batting', playerId, teamId);
    }

    function switchPlayerTab(tab, playerId, teamId) {
        const team = appData.teams.find(t => t.id === teamId);
        const player = team?.players.find(p => p.id === playerId);
        if (!player) return;

        document.getElementById('batting-tab').classList.toggle('active', tab === 'batting');
        document.getElementById('bowling-tab').classList.toggle('active', tab === 'bowling');
        const container = document.getElementById('player-stats-container');
        const stats = player.stats || {};

        if (tab === 'batting') {
            const battingStats = stats.batting || { runs: 0, balls: 0, fours: 0, sixes: 0 };
            const sr = battingStats.balls > 0 ? ((battingStats.runs || 0) / battingStats.balls * 100).toFixed(2) : '0.00';
            const avg = (battingStats.innings || 0) > 0 ? ((battingStats.runs || 0) / ((battingStats.innings || 0) - (battingStats.notOuts || 0) || 1)).toFixed(2) : '0.00';
            container.innerHTML = `<div class="stats-grid">
                <div class="stat-box"><div class="value">${stats.matches || 0}</div><div class="label">Matches</div></div>
                <div class="stat-box"><div class="value">${battingStats.innings || 0}</div><div class="label">Innings</div></div>
                <div class="stat-box"><div class="value">${battingStats.runs}</div><div class="label">Runs</div></div>
                <div class="stat-box"><div class="value">${sr}</div><div class="label">SR</div></div>
                <div class="stat-box"><div class="value">${avg}</div><div class="label">Average</div></div>
                <div class="stat-box"><div class="value">${battingStats.fours}</div><div class="label">Fours</div></div>
                <div class="stat-box"><div class="value">${battingStats.sixes}</div><div class="label">Sixes</div></div>
                <div class="stat-box"><div class="value">${battingStats.bestScore || 0}</div><div class="label">Best Score</div></div>
                <div class="stat-box"><div class="value">${battingStats.fifties || 0}</div><div class="label">Fifties</div></div>
                <div class="stat-box"><div class="value">${battingStats.hundreds || 0}</div><div class="label">Hundreds</div></div>
                <div class="stat-box"><div class="value">${battingStats.ducks || 0}</div><div class="label">Ducks</div></div>
            </div>`;
        } else {
            const bowlingStats = stats.bowling || { balls: 0, runs: 0, wickets: 0, maidens: 0, wides: 0, noballs: 0 };
            const overs = bowlingStats.balls > 0 ? `${Math.floor(bowlingStats.balls / 6)}.${bowlingStats.balls % 6}` : '0.0';
            const econ = bowlingStats.balls > 0 ? (bowlingStats.runs / (bowlingStats.balls / 6)).toFixed(2) : '0.00';
            const avg = (bowlingStats.wickets || 0) > 0 ? (bowlingStats.runs / bowlingStats.wickets).toFixed(2) : '0.00';
            container.innerHTML = `<div class="stats-grid">
                <div class="stat-box"><div class="value">${stats.matches || 0}</div><div class="label">Matches</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.innings || 0}</div><div class="label">Innings</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.wickets}</div><div class="label">Wickets</div></div>
                <div class="stat-box"><div class="value">${overs}</div><div class="label">Overs</div></div>
                <div class="stat-box"><div class="value">${econ}</div><div class="label">Economy</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.maidens}</div><div class="label">Maidens</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.runs}</div><div class="label">Runs Conceded</div></div>
                <div class="stat-box"><div class="value">${avg}</div><div class="label">Average</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.bestWickets || 0}/${bowlingStats.bestRuns || 0}</div><div class="label">Best Bowling</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.wides || 0}</div><div class="label">Wides</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.noballs || 0}</div><div class="label">No Balls</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.threeWickets || 0}</div><div class="label">3 Wickets</div></div>
                <div class="stat-box"><div class="value">${bowlingStats.fiveWickets || 0}</div><div class="label">5 Wickets</div></div>
            </div>`;
        }
    }


    // --- MATCH SETUP & CORE LOGIC ---
    const teamAInput = document.getElementById('teamA-input'), teamBInput = document.getElementById('teamB-input'), tossWinnerSelect = document.getElementById('toss-winner-select');
    function updateTossOptions() {
        const teamA = teamAInput.value.trim() || 'Team A';
        const teamB = teamBInput.value.trim() || 'Team B';
        tossWinnerSelect.innerHTML = `<option value="${teamA}">${teamA}</option><option value="${teamB}">${teamB}</option>`;
    }
    teamAInput.addEventListener('input', () => { matchState.teamA_id = null; updateTossOptions(); });
    teamBInput.addEventListener('input', () => { matchState.teamB_id = null; updateTossOptions(); });

    function openTeamSelectModal(teamKey) {
        const listEl = document.getElementById('team-select-modal-list');
        listEl.innerHTML = '';
        if (appData.teams.length === 0) {
            listEl.innerHTML = '<p>No teams saved. Go to the Teams tab to add one.</p>';
        } else {
            appData.teams.forEach(team => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.textContent = team.name;
                item.onclick = () => selectTeam(team.id, team.name, teamKey);
                listEl.appendChild(item);
            });
        }
        showModal('team-select-modal');
    }

    function selectTeam(teamId, teamName, teamKey) {
        if (teamKey === 'A') {
            document.getElementById('teamA-input').value = teamName;
            matchState.teamA_id = teamId;
        } else {
            document.getElementById('teamB-input').value = teamName;
            matchState.teamB_id = teamId;
        }
        updateTossOptions();
        closeModal('team-select-modal');
    }

    function startNewMatch() {
        matchState = getInitialState();
        const teamA_name = teamAInput.value.trim();
        const teamA_selected = appData.teams.find(t => t.name === teamA_name);
        if (teamA_selected) matchState.teamA_id = teamA_selected.id;

        const teamB_name = teamBInput.value.trim();
        const teamB_selected = appData.teams.find(t => t.name === teamB_name);
        if (teamB_selected) matchState.teamB_id = teamB_selected.id;

        if (!teamA_name || !teamB_name) { showToast("Please enter both team names."); return; }

        history = [JSON.parse(JSON.stringify(matchState))];
        matchState.settings.totalOvers = parseInt(document.getElementById('overs-input').value) || 0;
        if (matchState.settings.totalOvers <= 0) { showToast("Please enter a valid number of overs."); return; }

        matchState.settings.playersPerTeam = parseInt(document.getElementById('players-per-team-input').value);
        matchState.settings.wd = { reball: document.getElementById('wd-reball-toggle').checked, runs: parseInt(document.getElementById('wd-run-input').value) };
        matchState.settings.nb = { reball: document.getElementById('nb-reball-toggle').checked, runs: parseInt(document.getElementById('nb-run-input').value) };

        const tossWinnerName = tossWinnerSelect.value;
        const optedTo = document.querySelector('input[name="opted-to"]:checked').value;
        matchState.toss = `${tossWinnerName} won the toss and opted to ${optedTo}.`;

        if ((tossWinnerName === teamA_name && optedTo === 'bat') || (tossWinnerName === teamB_name && optedTo === 'ball')) {
            matchState.battingTeam = teamA_name;
            matchState.bowlingTeam = teamB_name;
            if(matchState.teamA_id) matchState.battingTeamObject = appData.teams.find(t => t.id === matchState.teamA_id);
            if(matchState.teamB_id) matchState.bowlingTeamObject = appData.teams.find(t => t.id === matchState.teamB_id);
        } else {
            matchState.battingTeam = teamB_name;
            matchState.bowlingTeam = teamA_name;
            if(matchState.teamB_id) matchState.battingTeamObject = appData.teams.find(t => t.id === matchState.teamB_id);
            if(matchState.teamA_id) matchState.bowlingTeamObject = appData.teams.find(t => t.id === matchState.teamA_id);
        }

        matchState.innings[1].team = matchState.battingTeam;
        matchState.innings[2].team = matchState.bowlingTeam;

        renderOpeningPlayerSelection(matchState.battingTeamObject, matchState.bowlingTeamObject);

        document.getElementById('select-players-header').innerText = `Select Players - ${matchState.battingTeam}`;
        document.getElementById('start-innings-btn').innerText = "1st Innings Start";
        navigate('select-opening-players-screen');
    }

    function renderOpeningPlayerSelection(battingTeam, bowlingTeam) {
        const strikerContainer = document.getElementById('striker-container');
        const nonStrikerContainer = document.getElementById('non-striker-container');
        const bowlerContainer = document.getElementById('opening-bowler-container');

        if (battingTeam && battingTeam.players.length > 0) {
            let options = '<option value="">Select Striker</option>';
            battingTeam.players.forEach(p => options += `<option value="${p.name}">${p.name}</option>`);
            strikerContainer.innerHTML = `<select id="striker-select">${options}</select>`;
            nonStrikerContainer.innerHTML = `<select id="non-striker-select">${options.replace('Select Striker', 'Select Non-Striker')}</select>`;
        } else {
            strikerContainer.innerHTML = `<input type="text" id="striker-input" placeholder="Enter Striker Name">`;
            nonStrikerContainer.innerHTML = `<input type="text" id="non-striker-input" placeholder="Enter Non-Striker Name">`;
        }

        if (bowlingTeam && bowlingTeam.players.length > 0) {
            let options = '<option value="">Select Bowler</option>';
            bowlingTeam.players.forEach(p => options += `<option value="${p.name}">${p.name}</option>`);
            bowlerContainer.innerHTML = `<select id="opening-bowler-select">${options}</select>`;
        } else {
            bowlerContainer.innerHTML = `<input type="text" id="opening-bowler-input" placeholder="Enter Bowler Name">`;
        }
    }

    function confirmOpeningPlayers() {
        const strikerEl = document.getElementById('striker-select') || document.getElementById('striker-input');
        const nonStrikerEl = document.getElementById('non-striker-select') || document.getElementById('non-striker-input');
        const bowlerEl = document.getElementById('opening-bowler-select') || document.getElementById('opening-bowler-input');

        const strikerName = strikerEl.value.trim();
        const nonStrikerName = nonStrikerEl.value.trim();
        const bowlerName = bowlerEl.value.trim();

        if (!strikerName || !nonStrikerName || !bowlerName) { showToast("Please select/enter all player names."); return; }
        if (strikerName === nonStrikerName) { showToast("Striker and Non-Striker cannot be the same."); return; }

        saveState();
        const ci = matchState.innings[matchState.currentInnings]; const opponentInning = matchState.innings[matchState.currentInnings === 1 ? 2 : 1];
        const striker = { id: generateUniqueId(), name: strikerName, runs: 0, balls: 0, fours: 0, sixes: 0, onStrike: true, out: false, retired: false };
        const nonStriker = { id: generateUniqueId(), name: nonStrikerName, runs: 0, balls: 0, fours: 0, sixes: 0, onStrike: false, out: false, retired: false };
        matchState.batsmen = [striker, nonStriker]; ci.allBatsmen.push(striker, nonStriker);
        matchState.currentPartnership = { runs: 0, balls: 0, batsmen: [striker.name, nonStriker.name] };
        const newBowler = { id: generateUniqueId(), name: bowlerName, overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0 };
¬† ¬† ¬† ¬† matchState.bowlers.push(newBowler); ci.allBowlers.push(newBowler);
¬† ¬† ¬† ¬† matchState.currentBowlerId = newBowler.id;
        renderScorecard(); navigateReplace('scorecard-screen');
    }

    function saveState() {
        history.push(JSON.parse(JSON.stringify(matchState)));
        // Save the current state to local storage for recovery
        if (matchState && matchState.id) {
            localStorage.setItem('inProgressMatch', JSON.stringify(matchState));
        }
    }

    function undoLastAction() {
        if (history.length > 1) {
            history.pop(); // Remove current state
            const prevState = history[history.length - 1]; // Get the previous state

            // ‡¶è‡¶á deep copy ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≠‡ßá‡¶ô‡ßá ‡¶¶‡ßá‡ßü
            matchState = JSON.parse(JSON.stringify(prevState)); 
            
            // --- START: COMPLETE UNDO FIX ---
            // ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶â‡¶≠‡¶Ø‡¶º ‡¶á‡¶®‡¶ø‡¶Ç‡¶∏‡ßá‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá,
            // ‡¶ï‡¶æ‡¶∞‡¶£ JSON.parse ‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶≠‡ßá‡¶ô‡ßá ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§

            // Since matchState is a deep copy of prevState, all internal references are already correct.
            // The complex relinking logic is not needed.
            localStorage.setItem('inProgressMatch', JSON.stringify(matchState));
            renderScorecard();
            showToast("Undo Successful");
        } else {
            showToast("Nothing to undo");
        }
    }

    function handleExtra(type) { document.querySelectorAll('.scoring-controls .btn').forEach(b => b.classList.remove('active')); document.getElementById(type + '-btn').classList.add('active'); matchState.currentExtra = type; }

    function handleRun(run) {
        if (matchState.isOverComplete) { showToast("Over is complete. Please start a new over."); return; }

        const ci = matchState.innings[matchState.currentInnings];
        const cb = matchState.bowlers.find(b => b.id === matchState.currentBowlerId);
        const striker = matchState.batsmen.find(b => b.onStrike && !b.out && !b.retired);
        const extraType = matchState.currentExtra;
        let isLegalBall = true; 

        if (extraType) {
            if (extraType === 'nb') {
                const extraSettings = matchState.settings.nb;
                isLegalBall = !extraSettings.reball;
                if (striker) {
                    striker.runs += run;
                }
                const totalRuns = run + extraSettings.runs;
                ci.score += totalRuns;
                ci.extras.nb += extraSettings.runs;
                ci.extras.total += extraSettings.runs;
                if(cb) cb.runs += totalRuns;
                matchState.thisOver.push(run + 'nb');
                if (run % 2 !== 0) swapBatsmen();
            } else if (extraType === 'wd') {
                const extraSettings = matchState.settings.wd;
                isLegalBall = !extraSettings.reball;
                const totalExtraRuns = run + extraSettings.runs;
                ci.score += totalExtraRuns;
                ci.extras.wd += totalExtraRuns;
                ci.extras.total += totalExtraRuns;
                if(cb) cb.runs += totalExtraRuns;
                matchState.thisOver.push(run + 'wd');
                if (run % 2 !== 0) swapBatsmen();
            } else if (extraType === 'byes' || extraType === 'lb') {
                isLegalBall = true;
                ci.score += run;
                ci.extras[extraType] += run;
                ci.extras.total += run;
                if(striker) striker.balls++;
                matchState.thisOver.push(run + extraType.charAt(0));
                if (run % 2 !== 0) swapBatsmen();
            }
        } else if (striker) {
            isLegalBall = true;
            striker.runs += run;
            striker.balls++;
            if (run === 4) striker.fours++;
            if (run === 6) striker.sixes++;
            ci.score += run;
            if (cb) cb.runs += run;
            matchState.currentPartnership.runs += run;
            matchState.thisOver.push(run);
            if (run % 2 !== 0) swapBatsmen();
        }

        if (isLegalBall) {
            ci.balls++;
            if (cb) cb.balls++;
            matchState.currentPartnership.balls++;
        }

        matchState.currentExtra = null;
        document.querySelectorAll('.scoring-controls .btn').forEach(b => b.classList.remove('active'));

        if (isGameOver()) {
            handleInningsEnd();
        } else if (isLegalBall && ci.balls > 0 && ci.balls % 6 === 0) {
            
            // --- START: NEW MAIDEN LOGIC ---
            let isMaiden = true;
            // ‡¶è‡¶á ‡¶ì‡¶≠‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶æ‡¶® (1-6) ‡¶¨‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ (wd, nb) ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
            for (const ball of matchState.thisOver) {
                if (typeof ball === 'number' && ball > 0) { // 1, 2, 3, 4, 5, 6
                    isMaiden = false;
                    break;
                }
                const ballStr = String(ball);
                if (ballStr.includes('wd') || ballStr.includes('nb')) { // 'wd', '1wd', 'nb', '4nb'
                    isMaiden = false;
                    break;
                }
                // 'W', 0, 'b', 'lb' ‡¶π‡¶≤‡ßá ‡¶Æ‡ßá‡¶á‡¶°‡ßá‡¶® ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡ßá
            }
            
            if (isMaiden && cb) {
                cb.maidens = (cb.maidens || 0) + 1;
                showToast("Maiden Over!");
            }
            // --- END: NEW MAIDEN LOGIC ---

            matchState.isOverComplete = true;
            swapBatsmen();
        }

        saveState(); // ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        renderScorecard();
    }


    function swapBatsmen(manual = false) {
        // if(manual) saveState(); // <-- ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá

        const onStrike = matchState.batsmen.find(b => b.onStrike && !b.out && !b.retired); 
        const nonStrike = matchState.batsmen.find(b => !b.onStrike && !b.out && !b.retired);
        
        if(onStrike) onStrike.onStrike = false; 
        if(nonStrike) nonStrike.onStrike = true;
        
        if(manual) {
            saveState(); // <-- ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶ï‡¶æ‡¶ú ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞)
            renderScorecard();
        }
    }

    function confirmNewBowler() {
        const bowlerEl = document.getElementById('new-bowler-select') || document.getElementById('new-bowler-input');
        const bowlerName = bowlerEl.value.trim();
 
        // --- *** ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£: ‡¶¨‡ßã‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶®‡¶æ *** ---
        if(!bowlerName) { 
            showToast("Please select or enter a bowler name."); 
            return; // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á ‡¶∂‡ßá‡¶∑ ‡¶π‡¶¨‡ßá, ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
        }
 
        const ci = matchState.innings[matchState.currentInnings];
¬† ¬† ¬† ¬† let bowler = ci.allBowlers.find(b => b.name === bowlerName);
¬† ¬† ¬† ¬† if(!bowler) {
¬† ¬† ¬† ¬† ¬† ¬† bowler = { id: generateUniqueId(), name: bowlerName, overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0 };
¬† ¬† ¬† ¬† ¬† ¬† ci.allBowlers.push(bowler);
¬† ¬† ¬† ¬† }
        
        // --- START FIX ---
        // matchState.bowlers = [bowler]; // <-- ‡¶è‡¶á ‡¶≠‡ßÅ‡¶≤ ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        
        // ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:
        // ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡ßã‡¶≤‡¶æ‡¶∞‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá "‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º" ‡¶¨‡ßã‡¶≤‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
        if (!matchState.bowlers.find(b => b.id === bowler.id)) {
            matchState.bowlers.push(bowler); // ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        }
        // --- END FIX ---

        
        matchState.currentBowlerId = bowler.id;

        // *** ‡¶è‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°‡¶ü‡ßÅ‡¶ï‡ßÅ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶ì‡¶≠‡¶æ‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ***
¬† ¬† ¬† ¬† if (matchState.thisOver.length > 0) {
            // ci.allBowlers ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßã‡¶≤‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®, ‡¶ï‡¶æ‡¶∞‡¶£ matchState.bowlers ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá
¬† ¬† ¬† ¬† ¬† ¬† const bowler = ci.allBowlers.find(b => b.id === matchState.currentBowlerId);
¬† ¬† ¬† ¬† ¬† ¬† ci.allOvers.push({ 
                bowlerName: bowler ? bowler.name : 'Unknown', 
                balls: [...matchState.thisOver] 
            });
¬† ¬† ¬† ¬† }
        // *** ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶∂‡ßá‡¶∑ ***
        matchState.thisOver = [];
        closeModal('choose-bowler-modal');

        matchState.isOverComplete = false;
        saveState();
        renderScorecard();
    }

    function renderNewBowlerSelection() {
        const container = document.getElementById('new-bowler-container');
        const bowlingTeam = matchState.bowlingTeamObject;

        if (bowlingTeam && bowlingTeam.players.length > 0) {
            const lastBowler = matchState.bowlers.find(b => b.id === matchState.currentBowlerId);
            let options = '<option value="">Select Bowler</option>';
            bowlingTeam.players.forEach(p => {
                if (!lastBowler || p.name !== lastBowler.name) {
                    options += `<option value="${p.name}">${p.name}</option>`;
                }
            });
            container.innerHTML = `<select id="new-bowler-select">${options}</select>`;
        } else {
            container.innerHTML = `<input type="text" id="new-bowler-input" placeholder="Enter new bowler's name">`;
        }
    }

    // *** NEW FUNCTION ***
    function renderNewBatsmanSelection() {
        const battingTeam = matchState.battingTeamObject;
        const containerWicket = document.getElementById('new-batsman-container-wicket');
        const containerRetire = document.getElementById('new-batsman-container-retire');

        // ‡¶è‡¶á ‡¶á‡¶®‡¶ø‡¶Ç‡¶∏‡ßá ‡¶Ø‡¶æ‡¶∞‡¶æ ‡¶Ö‡¶≤‡¶∞‡ßá‡¶°‡¶ø ‡¶ñ‡ßá‡¶≤‡ßá‡¶õ‡ßá (‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶õ‡ßá, ‡¶Ü‡¶â‡¶ü) ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
        const playersInMatch = matchState.innings[matchState.currentInnings].allBatsmen.map(b => b.name);
        // ‡¶Ø‡¶æ‡¶∞‡¶æ ‡¶∞‡¶ø‡¶ü‡¶æ‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Ü‡¶â‡¶ü ‡¶π‡ßü‡¶®‡¶ø, ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
        const retiredBatsmen = matchState.innings[matchState.currentInnings].allBatsmen.filter(b => b.retired && !b.out);

        if (battingTeam && battingTeam.players.length > 0) {
            let optionsHTML = '<option value="">Select Batsman</option>';
            
            // --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ---
            const newPlayers = battingTeam.players.filter(player => !playersInMatch.includes(player.name));
            if (newPlayers.length > 0) {
                optionsHTML += '<optgroup label="New Batsmen">';
                newPlayers.forEach(player => {
                    optionsHTML += `<option value="${player.name}">${player.name}</option>`;
                });
                optionsHTML += '</optgroup>';
            }

            // --- ‡¶∞‡¶ø‡¶ü‡¶æ‡ßü‡¶æ‡¶∞ ‡¶π‡¶ì‡ßü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ---
            if (retiredBatsmen.length > 0) {
                optionsHTML += '<optgroup label="Returning Batsmen">';
                retiredBatsmen.forEach(player => {
                    optionsHTML += `<option value="${player.name}">${player.name}</option>`;
                });
                optionsHTML += '</optgroup>';
            }

            // ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡¶á ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
            const selectHTMLWicket = `<select id="new-batsman-select-wicket">${optionsHTML}</select>`;
            // ‡¶∞‡¶ø‡¶ü‡¶æ‡ßü‡¶æ‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            let retireOptionsHTML = '<option value="">Select New Batsman</option>';
            newPlayers.forEach(player => {
                retireOptionsHTML += `<option value="${player.name}">${player.name}</option>`;
            });
            const selectHTMLRetire = `<select id="new-batsman-select-retire">${retireOptionsHTML}</select>`;
            
            containerWicket.innerHTML = selectHTMLWicket;
            containerRetire.innerHTML = selectHTMLRetire;
        } else {
            // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶ø‡¶Æ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
            containerWicket.innerHTML = `<input type="text" id="new-batsman-input-wicket" placeholder="Enter new batsman name">`;
            containerRetire.innerHTML = `<input type="text" id="new-batsman-input-retire" placeholder="Enter new batsman name">`;
        }
    }

    function forceNewOver() {
        if (!matchState.isOverComplete) {
            showToast("Over is not yet complete.");
            return;
        }
        renderNewBowlerSelection();
        showModal('choose-bowler-modal');
    }

    // *** ‡¶è‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ***
function toggleRunOutRuns(wicketType) {
    const runOutGroup = document.getElementById('run-out-runs-group');
    if (wicketType.toLowerCase().includes('run out')) {
        runOutGroup.style.display = 'block';
    } else {
        runOutGroup.style.display = 'none';
        document.getElementById('run-out-runs-input').value = '0';
    }
}

    // *** MODIFIED FUNCTION ***
    function handleWicket() {
    if(matchState.isOverComplete){ showToast("Over complete. Start new over."); return; }
    
    renderNewBatsmanSelection(); // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá

    // ‡¶´‡¶∞‡ßç‡¶Æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    document.getElementById('wicket-type').value = 'Bowled'; // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶®‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    toggleRunOutRuns('Bowled'); // ‡¶∞‡¶æ‡¶®-‡¶Ü‡¶â‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡¶ü‡¶ø ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®

    showModal('fall-of-wicket-modal');
}
    
    // *** MODIFIED FUNCTION ***
    function handleRetire() { 
        if(matchState.isOverComplete){ showToast("Over complete. Start new over."); return; } 
        renderNewBatsmanSelection(); // <-- This line is added
        showModal('retire-modal'); 
    }

    // *** MODIFIED FUNCTION ***
    function confirmNewBatsman(type) {
    saveState(); // ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡¶ø‡¶®

    // --- START: NEW VALIDATION FOR WICKET & RETIRE ---
    if (type === 'wicket' || type === 'retire') {
        const elId = (type === 'wicket') ? 'new-batsman-select-wicket' : 'new-batsman-select-retire';
        const inputId = (type === 'wicket') ? 'new-batsman-input-wicket' : 'new-batsman-input-retire';
        const el = document.getElementById(elId) || document.getElementById(inputId);
        const newName = el.value.trim();

        // ‡¶Ø‡¶¶‡¶ø ‡¶ñ‡ßá‡¶≤‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ ‡¶π‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡¶æ ‡¶π‡ßü
        if (!isGameOver() && !newName && type === 'wicket') {
            // ‡¶Ø‡¶¶‡¶ø ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶®‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶Ö‡¶™‡¶∂‡¶® ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡¶≤‡ßÅ‡¶®
            if (el.tagName === 'SELECT' && el.options.length > 1) {
                 showToast("Please select a new batsman.");
                 history.pop(); // ‡¶Ø‡ßá‡¶π‡ßá‡¶§‡ßÅ ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶ú ‡¶π‡ßü‡¶®‡¶ø, ‡¶§‡¶æ‡¶á ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
                 return; // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á ‡¶∂‡ßá‡¶∑, ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
            }
        }
    }
    // --- END: NEW VALIDATION ---


    const ci = matchState.innings[matchState.currentInnings];
    const cb = matchState.bowlers.find(b => b.id === matchState.currentBowlerId);

    // --- 'RETIRE' LOGIC (‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã) ---
    if (type === 'retire') {
        // ‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶∞‡¶ø‡¶ü‡¶æ‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡ßá‡¶® ‡¶§‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
        const outBatsman = matchState.batsmen.find(b => b.onStrike && !b.out && !b.retired);
        if (outBatsman) {
            outBatsman.retired = true;
            outBatsman.onStrike = false;
        }

        // ‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶®
        const el = document.getElementById('new-batsman-select-retire') || document.getElementById('new-batsman-input-retire');
        const newName = el.value.trim();
        closeModal('retire-modal');

        // ‡¶ß‡¶æ‡¶™ ‡ß©: ‡¶ñ‡ßá‡¶≤‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶ø‡¶®‡¶æ ‡¶¨‡¶æ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶§‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (isGameOver()) {
            handleInningsEnd();
            return; // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∂‡ßá‡¶∑
        }

        // ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶ï‡ßá ‡¶ï‡ßç‡¶∞‡¶ø‡¶ú‡ßá ‡¶Ü‡¶®‡ßÅ‡¶®
        if (newName) {
            const newBatsman = { id: generateUniqueId(), name: newName, runs: 0, balls: 0, fours: 0, sixes: 0, onStrike: true, out: false, retired: false };
            matchState.batsmen.push(newBatsman);
            ci.allBatsmen.push(newBatsman);

            // ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
            const otherActiveBatsman = matchState.batsmen.find(b => b.id !== newBatsman.id && !b.out && !b.retired);
            
            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶®‡¶æ‡¶∞‡¶∂‡¶ø‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
            matchState.currentPartnership = { runs: 0, balls: 0, batsmen: [newName, otherActiveBatsman ? otherActiveBatsman.name : ''] };
            
            renderScorecard();
        } else {
            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶®‡ßá‡¶á, ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ ‡¶∏‡¶¨ ‡¶Ü‡¶â‡¶ü
            showToast("No new batsman available.");
            renderScorecard();
        }
        return; // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∂‡ßá‡¶∑
    }

    // --- 'WICKET' LOGIC (‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï) ---
    if (type === 'wicket') {
        const extraType = matchState.currentExtra; // 'wd', 'nb', 'byes', 'lb' ‡¶¨‡¶æ null
        
        // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡¶ø‡¶®
        const wicketType = document.getElementById('wicket-type').value;
        const isRunOut = wicketType.toLowerCase().includes('run out');
        const runsCompleted = parseInt(document.getElementById('run-out-runs-input').value) || 0;
        let dismissalText = wicketType;

        let isLegalBall = true;
        let ballEvent = 'W';

        // ‡ßß. ‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ü‡¶â‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶§‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßá‡¶â ‡¶ï‡ßç‡¶∞‡¶ø‡¶ú‡ßá ‡¶•‡¶æ‡¶ï‡ßá)
        let outBatsman;
        if (wicketType === 'Run out striker') {
            outBatsman = matchState.batsmen.find(b => b.onStrike && !b.out && !b.retired); // ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶á‡¶ï‡¶æ‡¶∞‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
        } else if (wicketType === 'Run out Non-striker') {
            // ‡¶®‡¶®-‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶á‡¶ï‡¶æ‡¶∞‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
            outBatsman = matchState.batsmen.find(b => !b.onStrike && !b.out && !b.retired);
        } else {
            // Bowled, Catch, LBW, Stumping ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶∞‡ßç‡¶¨‡¶¶‡¶æ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶á‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶â‡¶ü ‡¶π‡ßü
            outBatsman = matchState.batsmen.find(b => b.onStrike && !b.out && !b.retired);
        }
        
        const strikerOnBall = matchState.batsmen.find(b => b.onStrike && !b.out && !b.retired);

        // ‡ß®. ‡¶∞‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß)
        if (extraType) {
            // ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ ‡¶¨‡¶≤‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶â‡¶á‡¶ï‡ßá‡¶ü
            if (extraType === 'nb') {
                const extraSettings = matchState.settings.nb;
                isLegalBall = !extraSettings.reball;
                const totalRuns = runsCompleted + extraSettings.runs; // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶® + No Ball ‡¶™‡ßá‡¶®‡¶æ‡¶≤‡ßç‡¶ü‡¶ø

                if (strikerOnBall && runsCompleted > 0) strikerOnBall.runs += runsCompleted;
                
                ci.score += totalRuns;
                ci.extras.nb += extraSettings.runs;
                ci.extras.total += extraSettings.runs;
                if (cb) cb.runs += totalRuns;
                
                // No-ball ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßã‡¶≤‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                if (cb) {
                    cb.noballs = (cb.noballs || 0) + 1;
                }
                ballEvent = `${runsCompleted}nb+W`;

            } else if (extraType === 'wd') {
                const extraSettings = matchState.settings.wd;
                isLegalBall = !extraSettings.reball;
                const totalExtraRuns = runsCompleted + extraSettings.runs; // Wide-‡¶è ‡¶∏‡¶¨ ‡¶∞‡¶æ‡¶® ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ

                ci.score += totalExtraRuns;
                ci.extras.wd += totalExtraRuns;
                ci.extras.total += totalExtraRuns;
                if (cb) cb.runs += totalExtraRuns;

                // Wide ‡¶¨‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßã‡¶≤‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                if (cb) {
                    cb.wides = (cb.wides || 0) + 1;
                }
                ballEvent = `${totalExtraRuns}wd+W`; // ‡¶Ø‡ßá‡¶Æ‡¶®: 1 ‡¶∞‡¶æ‡¶® ‡¶π‡¶≤‡ßá (1+1=2) "2wd+W"

            } else if (extraType === 'byes' || extraType === 'lb') {
                isLegalBall = true;
                ci.score += runsCompleted;
                ci.extras[extraType] += runsCompleted;
                ci.extras.total += runsCompleted;
                if (strikerOnBall) strikerOnBall.balls++; // ‡¶¨‡¶æ‡¶á/‡¶≤‡ßá‡¶ó ‡¶¨‡¶æ‡¶á‡¶§‡ßá ‡¶¨‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡ßü
                ballEvent = `${runsCompleted}${extraType.charAt(0)}+W`;
            }

        } else {
            // ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶¨‡¶≤‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶â‡¶á‡¶ï‡ßá‡¶ü (‡¶∞‡¶æ‡¶® ‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ö ‡¶¨‡¶æ ‡¶¨‡ßã‡¶≤‡ßç‡¶°)
            isLegalBall = true;
            if (strikerOnBall && runsCompleted > 0) {
                strikerOnBall.runs += runsCompleted;
                // (‡¶è‡¶ñ‡¶æ‡¶®‡ßá 4, 6 ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá, ‡¶§‡¶¨‡ßá ‡¶∞‡¶æ‡¶®-‡¶Ü‡¶â‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ü‡¶ø ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶π‡ßü ‡¶®‡¶æ)
            }
            ci.score += runsCompleted;
            if (cb) cb.runs += runsCompleted;
            matchState.currentPartnership.runs += runsCompleted;
            ballEvent = runsCompleted > 0 ? `${runsCompleted}+W` : 'W';
        }

        // ‡ß©. ‡¶â‡¶á‡¶ï‡ßá‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
        ci.wickets++;
        // ‡¶∞‡¶æ‡¶®-‡¶Ü‡¶â‡¶ü ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶¨‡ßã‡¶≤‡¶æ‡¶∞‡ßá‡¶∞ ‡¶â‡¶á‡¶ï‡ßá‡¶ü ‡¶¨‡¶æ‡ßú‡ßá
        if (!isRunOut && cb) {
            cb.wickets++;
            dismissalText = `${wicketType} b ${cb.name}`; // ‡¶Ø‡ßá‡¶Æ‡¶®: "Bowled b BowlerName"
        }

        if (isLegalBall) {
            ci.balls++;
            if (cb) cb.balls++;
            matchState.currentPartnership.balls++;
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡¶ø‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶¨‡¶≤‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶æ‡¶á/‡¶≤‡ßá‡¶ó ‡¶¨‡¶æ‡¶á ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡ßü
            if (strikerOnBall && extraType !== 'wd' && extraType !== 'byes' && extraType !== 'lb') {
                 // strikerOnBall.balls++; // <-- ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶®‡¶ø‡¶ö‡ßá ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá
            }
        }
        matchState.thisOver.push(ballEvent);
        if (outBatsman) { // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶∏‡¶§‡ßç‡¶Ø‡¶ø‡¶á ‡¶Ü‡¶â‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá
            const totalLegalBalls = ci.balls;
            const ov = Math.floor(totalLegalBalls / 6);
            const b = totalLegalBalls % 6;
            let overString = `${ov}.${b}`;
            
            if (isLegalBall && b === 0 && totalLegalBalls > 0) {
                // ‡ß¨‡¶∑‡ßç‡¶† ‡¶≤‡¶ø‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶¨‡¶≤, ‡¶§‡¶æ‡¶á ‡¶è‡¶ü‡¶ø ‡ß¨.‡ß¶, ‡ß´.‡ß¨ ‡¶®‡ßü
                overString = `${ov}.0`; 
            } else if (isLegalBall) {
                // ‡¶¨‡¶≤ ‡ßß-‡ß´, ‡¶§‡¶æ‡¶á ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ì‡¶≠‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                // ‡¶Ø‡ßá‡¶Æ‡¶®: ‡ßß‡¶Æ ‡¶¨‡¶≤‡ßá (totalLegalBalls=1), overString ‡¶π‡¶¨‡ßá 0.1
                overString = `${Math.floor((totalLegalBalls - 1) / 6)}.${b}`;
            } else {
                // ‡¶á‡¶≤‡ßç‡¶≤‡¶ø‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶¨‡¶≤, ‡¶¨‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡ßú‡ßá‡¶®‡¶ø, ‡¶§‡¶æ‡¶á ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                const prevBalls = totalLegalBalls - 1;
                overString = `${Math.floor(prevBalls / 6)}.${prevBalls % 6}`;
            }

            const fowData = {
                batsmanName: outBatsman.name,
                score: ci.score, // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ï‡ßã‡¶∞
                wickets: ci.wickets, // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Æ‡ßã‡¶ü ‡¶â‡¶á‡¶ï‡ßá‡¶ü (‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ++ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
                overs: overString
            };
            ci.fallOfWickets.push(fowData);
        }

        // ‡ß™. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶∏‡ßã‡ßü‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶∞‡¶æ‡¶® ‡¶¨‡¶ø‡¶ú‡ßã‡ßú ‡¶π‡ßü)
        if (runsCompleted % 2 !== 0) {
            swapBatsmen(); // ‡¶§‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§ ‡¶¨‡¶¶‡¶≤ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá
        }

        // ‡ß´. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ï‡ßá ‡¶Ü‡¶â‡¶ü ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
        if (outBatsman) {
            outBatsman.out = true;
            outBatsman.onStrike = false;
            outBatsman.dismissal = dismissalText; // ‡¶Ü‡¶â‡¶ü ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã

            // --- *** ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶≤ ‡¶´‡ßá‡¶∏ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü *** ---
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡ßà‡¶ß ‡¶¨‡¶≤‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ì‡ßü‡¶æ‡¶á‡¶°/‡¶®‡ßã-‡¶¨‡¶≤ ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶≤ ‡¶´‡ßá‡¶∏ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡¶¨‡ßá
            if (outBatsman && isLegalBall && extraType !== 'wd' && extraType !== 'nb') {
                 outBatsman.balls++;
            }
        }

        // ‡ß¨. ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ ‡¶Æ‡ßã‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        matchState.currentExtra = null;
        document.querySelectorAll('.scoring-controls .btn').forEach(b => b.classList.remove('active'));

        // ‡ß≠. ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ï‡ßá ‡¶®‡¶ø‡¶®
        const el = document.getElementById('new-batsman-select-wicket') || document.getElementById('new-batsman-input-wicket');
        const newName = el.value.trim();
        closeModal('fall-of-wicket-modal');

        // ‡ßÆ. ‡¶ì‡¶≠‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
        if (isLegalBall && ci.balls > 0 && ci.balls % 6 === 0) {
            // ... (‡¶Æ‡ßá‡¶á‡¶°‡ßá‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï) ...
            let isMaiden = true;
            for (const ball of matchState.thisOver) {
                if (typeof ball === 'number' && ball > 0) { isMaiden = false; break; }
                const ballStr = String(ball);
                if (ballStr.includes('wd') || ballStr.includes('nb')) { isMaiden = false; break; }
            }
            if (isMaiden && cb) {
                cb.maidens = (cb.maidens || 0) + 1;
                showToast("Maiden Over!");
            }
            
            matchState.isOverComplete = true;
            swapBatsmen(); // ‡¶®‡¶§‡ßÅ‡¶® ‡¶ì‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßã‡ßü‡¶æ‡¶™
        }

        // ‡ßØ. ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ï‡ßá ‡¶ï‡ßç‡¶∞‡¶ø‡¶ú‡ßá ‡¶Ü‡¶®‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶ñ‡ßá‡¶≤‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ ‡¶π‡ßü)
        if (isGameOver()) { // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá isGameOver() ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶á ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            handleInningsEnd();
            return; // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á
        }
        
        if (!newName) {
            showToast("All out! No new batsman.");
            closeModal('fall-of-wicket-modal'); // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
            renderScorecard();
            return;
        }

        // --- START: Returning Batsman Logic ---
        let newBatsman = ci.allBatsmen.find(b => b.name === newName && b.retired);

        if (newBatsman) {
            // ‡¶á‡¶®‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶∞‡¶ø‡¶ü‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ø‡¶ø‡¶®‡¶ø ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá‡¶®
            newBatsman.retired = false; // ‡¶§‡¶æ‡¶ï‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            newBatsman.onStrike = true;

            // --- *** START: BUG FIX *** ---
            // ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã (retired) ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏‡¶ü‡¶ø ‡¶∏‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®
            matchState.batsmen = matchState.batsmen.filter(b => b.id !== newBatsman.id);
            // --- *** END: BUG FIX *** ---

            showToast(`${newName} has returned to bat.`);
        } else {
            // ‡¶á‡¶®‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®
            newBatsman = { id: generateUniqueId(), name: newName, runs: 0, balls: 0, fours: 0, sixes: 0, onStrike: true, out: false, retired: false };
            ci.allBatsmen.push(newBatsman);
        }
        // --- END: Returning Batsman Logic ---

        // ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§‡ßá ‡¶ï‡ßá ‡¶Ü‡¶õ‡ßá ‡¶§‡¶æ‡¶ï‡ßá ‡¶®‡¶®-‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶á‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®
        const nonStriker = matchState.batsmen.find(b => !b.out && !b.retired);
        if (nonStriker) {
            nonStriker.onStrike = false;
        }
        
        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ï‡ßá ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        matchState.batsmen.push(newBatsman);
        matchState.currentPartnership = { runs: 0, balls: 0, batsmen: [newName, nonStriker ? nonStriker.name : ''] };

        // ‡ßß‡ß¶. ‡¶∏‡¶¨‡¶∂‡ßá‡¶∑‡ßá ‡¶∏‡ßç‡¶ï‡ßã‡¶∞‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        renderScorecard();
    }
}
    function isGameOver() {
        const ci = matchState.innings[matchState.currentInnings];
        const totalBalls = matchState.settings.totalOvers * 6;

        // Condition 1: All out (considering returning batsmen)
        const availableBatsmenCount = (matchState.settings.playersPerTeam - 1) - ci.wickets;
        // If all batsmen are out AND there are no retired batsmen waiting to return
        if (availableBatsmenCount <= 0 && !ci.allBatsmen.some(b => b.retired && !b.out)) {
            return true;
        }

        if (ci.balls >= totalBalls) return true; // Overs completed
        if (matchState.currentInnings === 2 && matchState.target && ci.score >= matchState.target) return true;
        return false;
    }


    function handleInningsEnd(isLive = true) {
        const ci = matchState.innings[matchState.currentInnings];
¬† ¬† ¬† ¬† if (matchState.thisOver.length > 0) {
¬† ¬† ¬† ¬† ¬† ¬† const bowler = ci.allBowlers.find(b => b.id === matchState.currentBowlerId);
¬† ¬† ¬† ¬† ¬† ¬† ci.allOvers.push({ 
                bowlerName: bowler ? bowler.name : 'Unknown', 
                balls: [...matchState.thisOver] 
            });
¬† ¬† ¬† ¬† ¬† ¬† matchState.thisOver = [];
¬† ¬† ¬† ¬† }
        if(matchState.currentInnings === 1) {
            // --- START: MODIFIED INNINGS BREAK LOGIC ---
            matchState.target = ci.score + 1;
            matchState.isFirstInningsComplete = true; // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            if (isLive) {
                renderScorecard(); // UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶ï‡ßã‡¶∞‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                showToast("1st Innings Complete. Click 'Start 2nd Innings' to continue.");
            }
            // --- END: MODIFIED INNINGS BREAK LOGIC ---
        } else {
             localStorage.removeItem('inProgressMatch'); // Match finished, remove backup
             const i1 = matchState.innings[1]; const i2 = matchState.innings[2];
             if (i2.score >= matchState.target) { const wicketsLeft = matchState.settings.playersPerTeam - 1 - i2.wickets; matchState.result = `${i2.team} won by ${wicketsLeft} wickets.`; }
             else if (i2.score === i1.score) { matchState.result = "Match Draw."; }
             else { const runDiff = i1.score - i2.score; matchState.result = `${i1.team} won by ${runDiff} runs.`; }

             matchState.completionDate = new Date().toISOString();
             updatePlayerStats(matchState);
             updateTournamentPoints(matchState);
             appData.history.push(JSON.parse(JSON.stringify(matchState)));
             saveData();
             renderScorecard();
             setTimeout(() => {
                alert(matchState.result);
                renderMatchSummary(matchState);
                navigate('match-summary-screen');
             }, 100);
        }
    }

    function updatePlayerStats(matchData) {
        const findGlobalPlayer = (playerName) => {
            for (const team of appData.teams) {
                const player = team.players.find(p => p.name.trim().toLowerCase() === playerName.trim().toLowerCase());
                if (player) return player;
            }
            return null;
        };
        const processPlayerList = (playerList, type) => {
            playerList.forEach(playerPerf => {
                const playerProfile = findGlobalPlayer(playerPerf.name);
                if (playerProfile) {
                    if (!playerProfile.stats) {
                        playerProfile.stats = {};
                    }
                    if (!processedPlayerIDs.has(playerProfile.id)) {
                        playerProfile.stats.matches = (playerProfile.stats.matches || 0) + 1;
                        processedPlayerIDs.add(playerProfile.id);
                    }
                    if (type === 'batsman') {
                        if (!playerProfile.stats.batting) playerProfile.stats.batting = { innings: 0, runs: 0, balls: 0, fours: 0, sixes: 0, notOuts: 0, fifties: 0, hundreds: 0, ducks: 0, bestScore: 0 };
                        const stats = playerProfile.stats.batting;
                        
                        stats.innings = (stats.innings || 0) + 1;
                        stats.runs += playerPerf.runs;
                        stats.balls += playerPerf.balls;
                        stats.fours += playerPerf.fours;
                        stats.sixes += playerPerf.sixes;

                        if (playerPerf.out === false && playerPerf.retired === false) {
                            stats.notOuts = (stats.notOuts || 0) + 1;
                        }
                        if (playerPerf.runs >= 100) {
                            stats.hundreds = (stats.hundreds || 0) + 1;
                        } else if (playerPerf.runs >= 50) {
                            stats.fifties = (stats.fifties || 0) + 1;
                        }
                        if (playerPerf.runs === 0 && playerPerf.out === true) {
                            stats.ducks = (stats.ducks || 0) + 1;
                        }
                        if (playerPerf.runs > (stats.bestScore || 0)) {
                            stats.bestScore = playerPerf.runs;
                        }

                    } else if (type === 'bowler') {
                        if (!playerProfile.stats.bowling) playerProfile.stats.bowling = { innings: 0, balls: 0, runs: 0, wickets: 0, maidens: 0, wides: 0, noballs: 0, threeWickets: 0, fiveWickets: 0, bestWickets: 0, bestRuns: 999 };
                        const stats = playerProfile.stats.bowling;

                        stats.innings = (stats.innings || 0) + 1;
                        stats.balls += playerPerf.balls;
                        stats.runs += playerPerf.runs;
                        stats.wickets += playerPerf.wickets;
                        stats.maidens += playerPerf.maidens;
                        stats.wides += playerPerf.wides || 0;
                        stats.noballs += playerPerf.noballs || 0;

                        if (playerPerf.wickets >= 5) stats.fiveWickets = (stats.fiveWickets || 0) + 1;
                        else if (playerPerf.wickets >= 3) stats.threeWickets = (stats.threeWickets || 0) + 1;

                        if (playerPerf.wickets > (stats.bestWickets || 0) || (playerPerf.wickets === stats.bestWickets && playerPerf.runs < stats.bestRuns)) {
                            stats.bestWickets = playerPerf.wickets;
                            stats.bestRuns = playerPerf.runs;
                        }
                    }
                }
            });
        };
        const processedPlayerIDs = new Set();
        const allBatsmen = matchData.innings[1].allBatsmen.concat(matchData.innings[2].allBatsmen);
        const allBowlers = matchData.innings[1].allBowlers.concat(matchData.innings[2].allBowlers);
        
        processPlayerList(allBatsmen, 'batsman');
        processPlayerList(allBowlers, 'bowler');
    }

    function showSecondInningsPlayersScreen() {
        saveState(); // ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶á‡¶®‡¶ø‡¶Ç‡¶∏ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®

        matchState.currentInnings = 2;
        [matchState.battingTeam, matchState.bowlingTeam] = [matchState.bowlingTeam, matchState.battingTeam];
        [matchState.battingTeamObject, matchState.bowlingTeamObject] = [matchState.bowlingTeamObject, matchState.battingTeamObject];

        renderOpeningPlayerSelection(matchState.battingTeamObject, matchState.bowlingTeamObject);

        matchState.batsmen = [];
        matchState.bowlers = [];
        matchState.thisOver = [];
        matchState.currentBowlerId = null;
        matchState.isOverComplete = false;
        matchState.pendingRun = null;
        matchState.currentPartnership = { runs: 0, balls: 0, batsmen: [] };
        matchState.isFirstInningsComplete = false; // ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        matchState.currentExtra = null;

        document.getElementById('select-players-header').innerText = `Select Players - ${matchState.battingTeam}`;
        document.getElementById('start-innings-btn').innerText = "Start 2nd Innings";
        navigateReplace('select-opening-players-screen');
    }

    function addPenaltyRuns() { 
        // saveState(); // <-- ‡¶è‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑‡ßá ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
        const runs = parseInt(document.getElementById('penalty-run-input').value); 
        if(runs > 0) matchState.innings[matchState.currentInnings].score += runs; 
        closeModal('penalty-run-modal'); 
        
        saveState(); // <-- ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        renderScorecard(); 
    }
    function showPartnership() { showToast(`Partnership: ${matchState.currentPartnership.runs} (${matchState.currentPartnership.balls} balls)`); }
    function showExtras() { const extras = matchState.innings[matchState.currentInnings].extras; showToast(`Extras: ${extras.total} (Wd: ${extras.wd}, Nb: ${extras.nb}, B: ${extras.byes}, Lb: ${extras.lb})`); }

    // *** ‡¶è‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ***
/**
 * ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¶‡¶≤‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶®‡¶æ‡¶Æ (Abbreviation) ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§
 * ‡¶Ø‡ßá‡¶Æ‡¶®: "Dhaka South Zone" -> "DSZ"
 * ‡¶Ø‡ßá‡¶Æ‡¶®: "Card Operation" -> "CO"
 * ‡¶Ø‡ßá‡¶Æ‡¶®: "ID" -> "ID"
 * ‡¶Ø‡ßá‡¶Æ‡¶®: "Treasury" -> "TRE"
 */
function getTeamAbbreviation(teamName) {
    if (!teamName || typeof teamName !== 'string') return '';

    // ‡¶®‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶õ‡ßã‡¶ü ‡¶π‡ßü (‡¶Ø‡ßá‡¶Æ‡¶® "ID", "SDD"), ‡¶§‡¶¨‡ßá ‡¶∏‡ßá‡¶ü‡¶ø‡¶á ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡¶ø‡¶®
    if (teamName.length <= 4 && teamName.toUpperCase() === teamName) {
         return teamName; 
    }
    
    // ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶∂‡¶¨‡ßç‡¶¶‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (‡¶Ø‡ßá‡¶Æ‡¶® "Dhaka South Zone" ‡¶¨‡¶æ "Card Operation")
    const words = teamName.split(' ');
    
    if (words.length > 1) {
        // '&' ‡¶è‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶∂‡¶¨‡ßç‡¶¶ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        const mainWords = words.filter(word => word !== '&');
        // "Dhaka South Zone" -> ["Dhaka", "South", "Zone"] -> "DSZ"
        // "Card Operation" -> ["Card", "Operation"] -> "CO"
        return mainWords.map(word => word.charAt(0)).join('').toUpperCase();
    } else {
        // ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∂‡¶¨‡ßç‡¶¶‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (‡¶Ø‡ßá‡¶Æ‡¶® "Treasury" ‡¶¨‡¶æ "Principal")
        // "Treasury" -> "TRE"
        return teamName.substring(0, 3).toUpperCase();
    }
}
    // --- UI RENDERING ---
    function renderScorecard() {
        const ci = matchState.innings[matchState.currentInnings]; const overs = Math.floor(ci.balls / 6), ballsThisOver = ci.balls % 6;
¬† ¬† ¬† ¬† const totalOvers = matchState.settings.totalOvers;

    // --- *** START: Team Abbreviation Box (HTML) *** ---
    const battingTeamName = matchState.battingTeam;
    const teamAbbr = getTeamAbbreviation(battingTeamName);
    // .innerText ‡¶ï‡ßá .innerHTML ‡¶¶‡¶ø‡ßü‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶®‡¶§‡ßÅ‡¶® span ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    document.getElementById('scoreboard-main').innerHTML = `<span class="team-abbr-box">${teamAbbr}</span> <span class="score-display">${ci.score}/${ci.wickets} (${overs}.${ballsThisOver} / ${totalOvers}.0)</span>`;
    // --- *** END: Team Abbreviation Box (HTML) *** ---

¬† ¬† ¬† ¬† document.getElementById('scorecard-header-teams').innerText = `${matchState.battingTeam} vs ${matchState.bowlingTeam}`;
¬† ¬† ¬† ¬† const crr = ci.balls > 0 ? (ci.score / (ci.balls / 6 || 1)).toFixed(2) : '0.00'; let detailsText = `CRR: ${crr}`;
¬† ¬† ¬† ¬† 
    if(matchState.currentInnings === 2) {
        // --- *** START: RRR (Required Run Rate) Calculation *** ---
¬† ¬† ¬† ¬† ¬† ¬† const ballsRem = (matchState.settings.totalOvers * 6) - ci.balls; 
        const runsNeeded = matchState.target - ci.score;
        // RRR ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        const rrr = (ballsRem > 0 && runsNeeded > 0) ? (runsNeeded / (ballsRem / 6)).toFixed(2) : '0.00';

        // detailsText-‡¶è RRR ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        detailsText = `Target: ${matchState.target} | Need ${runsNeeded > 0 ? runsNeeded : 0} in ${ballsRem > 0 ? ballsRem : 0} balls | RRR: ${rrr}`;
        // --- *** END: RRR (Required Run Rate) Calculation *** ---

¬† ¬† ¬† ¬† ¬† ¬† if (matchState.result) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('new-match-from-scorecard-btn').style.display = 'flex';
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† } else { document.getElementById('new-match-from-scorecard-btn').style.display = 'none'; }
¬† ¬† ¬† ¬† document.getElementById('scoreboard-details').innerText = detailsText;
        document.getElementById('batsman-table').innerHTML = matchState.batsmen.filter(b => !b.out && !b.retired).map(b => { const sr = b.balls > 0 ? (b.runs / b.balls * 100).toFixed(2) : '0.00'; return `<tr><td>${b.name} ${b.onStrike ? 'üèè' : ''}</td><td>${b.runs}</td><td>${b.balls}</td><td>${b.fours}</td><td>${b.sixes}</td><td>${sr}</td></tr>`; }).join('');
        const bowler = matchState.bowlers.find(b => b.id === matchState.currentBowlerId);
        if (bowler) { const bowlerOvers = `${Math.floor(bowler.balls / 6)}.${bowler.balls % 6}`; const er = bowler.balls > 0 ? (bowler.runs / (bowler.balls/6 || 1)).toFixed(2) : '0.00'; document.getElementById('bowler-table').innerHTML = `<tr><td>${bowler.name}</td><td>${bowlerOvers}</td><td>${bowler.maidens}</td><td>${bowler.runs}</td><td>${bowler.wickets}</td><td>${er}</td></tr>`; }
        else { document.getElementById('bowler-table').innerHTML = ''; }

        const thisOverContainer = document.getElementById('this-over-display');
        thisOverContainer.innerHTML = '';
        matchState.thisOver.forEach(ball => {
            const ballElement = document.createElement('span');
            ballElement.className = 'ball-event';
            if (String(ball).toUpperCase().includes('W')) {
                ballElement.classList.add('wicket');
            }
            ballElement.textContent = ball;
            thisOverContainer.appendChild(ballElement);
        });

        // --- START: MODIFIED BUTTON VISIBILITY LOGIC ---
        const newOverBtn = document.getElementById('new-over-btn');
        const startSecondInningsBtn = document.getElementById('start-second-innings-btn');

        newOverBtn.style.display = matchState.isFirstInningsComplete ? 'none' : 'flex';
        startSecondInningsBtn.style.display = matchState.isFirstInningsComplete ? 'flex' : 'none';

        newOverBtn.classList.toggle('alert', matchState.isOverComplete && !matchState.isFirstInningsComplete);
        // --- END: MODIFIED BUTTON VISIBILITY LOGIC ---

        // ** MODIFIED: Publish score updates to viewers **
        publishPublicData();
    }

    function renderMatchSummary(sourceMatch = matchState) {
        const contentWrapper = document.getElementById('summary-content-wrapper');
        contentWrapper.dataset.matchId = sourceMatch.id; // Correctly set the match ID
        const content = document.getElementById('summary-content');
        content.innerHTML = '';

        // --- *** ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°: ‡¶ü‡¶∏‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá *** ---
        if (sourceMatch.toss) {
            // PDF-‡¶è ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
            content.innerHTML += `<div id="toss-summary-info" class="card" style="text-align: center; font-weight: 500; color: var(--text-primary-color); padding: 12px; background-color: #eaf5fc;">${sourceMatch.toss}</div>`;
        }

        const renderInning = (inningNum) => {
            const inning = sourceMatch.innings[inningNum];
            if (!inning || !inning.team) return '';
            
            // Batting Part
            let battingHTML = `<div class="card" id="inning-summary-${inningNum}-batting">
                <h3>${inning.team} - ${inning.score}/${inning.wickets} (${Math.floor(inning.balls/6)}.${inning.balls%6} Overs)</h3>`;

            battingHTML += `<h4>Batting</h4><div class="table-responsive"><table class="score-table"><thead><tr><th>Batsman</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead><tbody>`;
            inning.allBatsmen.forEach(b => {
                 const sr = b.balls > 0 ? (b.runs / b.balls * 100).toFixed(2) : '0.00';
                 
                 // --- START: IMPROVED DISMISSAL LOGIC FOR PDF ---
                 let dismissalHTML = `<span class="dismissal-info">not out</span>`; // Default
                 if (b.out) {
                     if (b.dismissal && b.dismissal.toLowerCase().includes('run out')) {
                         dismissalHTML = `<span class="dismissal-info">run out</span>`;
                     } else if (b.dismissal) {
                         dismissalHTML = `<span class="dismissal-info">${b.dismissal}</span>`;
                     }
                 } else if (b.retired) {
                     dismissalHTML = `<span class="dismissal-info">retired hurt</span>`;
                 }
                 // --- END: IMPROVED DISMISSAL LOGIC FOR PDF ---

                 battingHTML += `<tr>
                    <td class="batsman-name-cell">${b.name} ${dismissalHTML}</td> 
                    <td>${b.runs}</td><td>${b.balls}</td><td>${b.fours}</td><td>${b.sixes}</td><td>${sr}</td>
                </tr>`;
            });
            battingHTML += `<tr><td><strong>Extras</strong></td><td colspan="5">${inning.extras.total} (Wd:${inning.extras.wd}, Nb:${inning.extras.nb}, B:${inning.extras.byes}, Lb:${inning.extras.lb})</td></tr></tbody></table></div>`;
            battingHTML += `</div>`;

            // Bowling Part
            let bowlingHTML = '';
            if(inning && inning.allBowlers && inning.allBowlers.length > 0) {
                bowlingHTML = `<div class="card" id="inning-summary-${inningNum}-bowling">
                    <h4>Bowling</h4>
                    <div class="table-responsive">
                        <table class="score-table">
                            <thead><tr><th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>ER</th></tr></thead>
                            <tbody>`;
                inning.allBowlers.forEach(b => {
                    const bowlerOvers = `${Math.floor(b.balls / 6)}.${b.balls % 6}`;
                    const er = b.balls > 0 ? (b.runs / (b.balls / 6 || 1)).toFixed(2) : '0.00';
                    bowlingHTML += `<tr><td>${b.name}</td><td>${bowlerOvers}</td><td>${b.maidens}</td><td>${b.runs}</td><td>${b.wickets}</td><td>${er}</td></tr>`;
                });
                bowlingHTML += `</tbody></table></div></div>`;
            }

            // Fall of Wickets Part
            let fowHTML = '';
            if (inning.fallOfWickets && inning.fallOfWickets.length > 0) {
                fowHTML = `<div class="card" id="inning-summary-${inningNum}-fow">
                    <h4 style="margin-top: 20px; margin-bottom: 8px;">Fall of Wickets</h4>
                    <div class="fow-container">`;
                inning.fallOfWickets.forEach((fow, index) => {
                    fowHTML += `<span class="fow-item">
                        <span>(${fow.score}-${fow.wickets})</span> 
                        <strong>${fow.batsmanName}</strong> 
                        <span>(${fow.overs} ov)</span>
                       </span>`;
                    // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶™‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    if (index < inning.fallOfWickets.length - 1) {
                         fowHTML += `<span class="fow-separator">|</span>`;
                    }
                });
                fowHTML += `</div></div>`;
            }

            return battingHTML + bowlingHTML + fowHTML;
        }

        content.innerHTML += renderInning(1);
        if(sourceMatch.innings[2].balls > 0 || sourceMatch.innings[2].score > 0 || sourceMatch.result) {
            content.innerHTML += renderInning(2);
        }

        if (sourceMatch.result) {
            content.innerHTML += `<div class="card" id="match-result-summary" style="text-align: center; background: var(--accent-color); color: white;"><h3>${sourceMatch.result}</h3></div>`;
        }
    }

     // --- HISTORY ---
     // --- *** MODIFIED FUNCTION *** ---
    function renderHistoryList() {
        const content = document.getElementById('history-content');
        content.innerHTML = '';
        const inProgressMatchData = localStorage.getItem('inProgressMatch');
        const reversedHistory = [...appData.history].reverse();

        if (!inProgressMatchData && reversedHistory.length === 0) {
            content.innerHTML = '<div class="card"><p>No completed or in-progress matches found.</p></div>';
            return;
        }

        // Render In-Progress Match first
        if (inProgressMatchData) {
            try {
                const match = JSON.parse(inProgressMatchData);
                const matchCard = document.createElement('div');
                matchCard.className = 'card';
                matchCard.style.borderLeft = '4px solid var(--warning-color)'; // Highlight
                matchCard.dataset.matchData = inProgressMatchData; // ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®

                const ci = match.innings[match.currentInnings];
                const ci_num_text = match.currentInnings === 1 ? '1st' : '2nd';
                const overs = `${Math.floor(ci.balls/6)}.${ci.balls%6}`;

                matchCard.innerHTML = `
                    <div class="history-item-header">
                        <h4>${match.innings[1].team} vs ${match.innings[2].team}</h4>
                        <span class="date" style="color: var(--warning-color); font-weight: 700;">IN PROGRESS</span>
                    </div>
                    <div class="history-item-body">
                        <p style="color: var(--text-primary-color); font-weight: normal;">
                            ${match.battingTeam} are ${ci.score}/${ci.wickets} (${overs}) - ${ci_num_text} Innings
                        </p>
                        <div class="btn-group" style="margin-top: 8px;">
                            <button class="btn" style="background: var(--warning-color);" onclick="resumeMatchFromHistory(this.closest('.card').dataset.matchData)">Resume</button> <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
                            <button class="btn" style="background: var(--danger-color);" onclick="event.stopPropagation(); deleteHistoryItem('inProgressMatch');">Discard</button>
                        </div>
                    </div>
                `;
                content.appendChild(matchCard);
            } catch (e) {
                console.error("Failed to parse in-progress match for history list.", e);
                localStorage.removeItem('inProgressMatch'); // Clear corrupted data
            }
        }

        // Render Completed Matches
        reversedHistory.forEach(match => {
            const matchCard = document.createElement('div');
            matchCard.className = 'card';

            const date = match.completionDate
                ? new Date(match.completionDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
                : 'Date not available';

            matchCard.innerHTML = `
                <div class="history-item-header">
                    <h4>${match.innings[1].team} vs ${match.innings[2].team}</h4>
                    <span class="date">${date}</span>
                </div>
                <div class="history-item-body">
                    <p>${match.result}</p>
                    <div class="btn-group" style="margin-top: 8px;">
                        <button class="btn btn-secondary" onclick="viewHistoricMatch('${match.id}')">Scoreboard</button>
                        <button class="btn" style="background: var(--danger-color);" onclick="event.stopPropagation(); deleteHistoryItem('${match.id}');">Delete</button>
                    </div>
                </div>
            `;
            content.appendChild(matchCard);
        });
    }

    // --- *** NEW FUNCTION *** ---
    function resumeMatchFromHistory(matchDataString) {
        if (!matchDataString) {
            showToast("Error: Match data not found.");
            return;
        }
        try {
            const loadedMatch = JSON.parse(matchDataString);
            matchState = loadedMatch;
            history = [JSON.parse(JSON.stringify(matchState))]; // Reset undo stack
            renderScorecard();
            navigate('scorecard-screen');
            localStorage.removeItem('inProgressMatch'); // Remove from local storage after resuming
            showToast("Match resumed.");
        } catch (e) {
            console.error("Failed to parse in-progress match.", e);
            localStorage.removeItem('inProgressMatch');
            showToast("Could not resume match, data was corrupted.");
            renderHistoryList(); // Refresh history list to remove the bad entry
        }
    }


    function viewHistoricMatch(matchId) {
        const historicMatch = appData.history.find(m => m.id === matchId);
        if (historicMatch) {
            renderMatchSummary(historicMatch);
            navigate('match-summary-screen');
        } else {
            showToast('Could not find match data.');
        }
    }

    // --- *** MODIFIED FUNCTION *** ---
    function deleteHistoryItem(matchId) {
        if (matchId === 'inProgressMatch') {
            showConfirmationModal("Are you sure you want to discard this in-progress match?", () => {
                localStorage.removeItem('inProgressMatch');
                renderHistoryList();
                showToast("In-progress match discarded.");
            });
        } else {
            showConfirmationModal("Delete this match from history?", () => {
                appData.history = appData.history.filter(m => m.id !== matchId);
                saveData();
                renderHistoryList();
                showToast("Match deleted from history.");
            });
        }
    }
    // --- *** END MODIFICATIONS *** ---


    // --- TOURNAMENT ---
    // --- MODIFIED FUNCTION ---
    function resetTournamentState() {
        // --- DATA PRE-POPULATION (TOURNAMENT) ---
        tournamentState = {
            groups: {
                A: ["Corporate Credit", "Card Operation", "ICT Operation"],
                B: ["Dhaka South Zone", "Narayangonj Zone", "Dhaka Central Zone"],
                C: ["Treasury", "Card Business", "CAM & RD"],
                D: ["ID", "SDD", "Principal"]
            },
            fixtures: {
                group: [
                    { team1: 'Dhaka Central Zone', team2: 'Dhaka South Zone', played: false },
                    { team1: 'ID', team2: 'Principal', played: false },
                    { team1: 'Card Operation', team2: 'ICT Operation', played: false },
                    { team1: 'Treasury', team2: 'CAM & RD', played: false },
                    { team1: 'SDD', team2: 'Principal', played: false },
                    { team1: 'Dhaka Central Zone', team2: 'Narayangonj Zone', played: false },
                    { team1: 'Corporate Credit', team2: 'Card Operation', played: false },
                    { team1: 'ID', team2: 'SDD', played: false },
                    { team1: 'Card Business', team2: 'Treasury', played: false },
                    { team1: 'Dhaka South Zone', team2: 'Narayangonj Zone', played: false },
                    { team1: 'Corporate Credit', team2: 'ICT Operation', played: false },
                    { team1: 'CAM & RD', team2: 'Card Business', played: false }
                ],
                quarter: [],
                semi: [],
                final: []
            },
            points: {},
            results: {
                'group-0': { dateTime: 'Nov 7, Time- 7:30 to 10:00', score1: '', score2: '', summary: '' },
                'group-1': { dateTime: 'Nov 7, Time- 10:00 to 12:30', score1: '', score2: '', summary: '' },
                'group-2': { dateTime: 'Nov 7, Time- 12:30 to 3:00', score1: '', score2: '', summary: '' },
                'group-3': { dateTime: 'Nov 14, Time- 7:30 to 10:00', score1: '', score2: '', summary: '' },
                'group-4': { dateTime: 'Nov 14, Time- 10:00 to 12:30', score1: '', score2: '', summary: '' },
                'group-5': { dateTime: 'Nov 14, Time- 12:30 to 3:00', score1: '', score2: '', summary: '' },
                'group-6': { dateTime: 'Nov 15, Time- 7:30 to 10:00', score1: '', score2: '', summary: '' },
                'group-7': { dateTime: 'Nov 15, Time- 10:00 to 12:30', score1: '', score2: '', summary: '' },
                'group-8': { dateTime: 'Nov 15, Time- 12:30 to 3:00', score1: '', score2: '', summary: '' },
                'group-9': { dateTime: 'Nov 21, Time- 7:30 to 10:00', score1: '', score2: '', summary: '' },
                'group-10': { dateTime: 'Nov 21, Time- 10:00 to 12:30', score1: '', score2: '', summary: '' },
                'group-11': { dateTime: 'Nov 21, Time- 12:30 to 3:00', score1: '', score2: '', summary: '' }
            }
        };
        // --- END PRE-POPULATION ---
    }
    // --- END MODIFIED FUNCTION ---

    function renderTournamentFixtures() {
        const content = document.getElementById('tournament-content-wrapper');
        const saveBtnContainer = document.getElementById('tournament-save-btn-container');
        const fixtureHTML = `<div class="card"><h3>Groups</h3>
                ${['A', 'B', 'C', 'D'].map(group => `<div class="form-group"><label>Group ${group}</label><div id="group-${group}-teams"></div><div class="add-btn" onclick="addTeamInput('${group}')"><i class="material-icons">add</i> Add Team</div></div>`).join('')}
            </div>
            ${createFixtureSection('Group Stage', 'group')} ${createFixtureSection('Quarter Final Stage', 'quarter')}
            ${createFixtureSection('Semi Final Stage', 'semi')} ${createFixtureSection('Final Stage', 'final')}`;
        content.innerHTML = fixtureHTML;
        ['A', 'B', 'C', 'D'].forEach(group => renderGroupTeamInputs(group));
        ['group', 'quarter', 'semi', 'final'].forEach(stage => renderMatchRows(stage));
        saveBtnContainer.style.display = 'block';
    }

    function createFixtureSection(title, stageKey) { return `<div class="card"><h3>${title}</h3><div id="${stageKey}-stage-matches"></div><div class="add-btn" onclick="addMatchRow('${stageKey}')"><i class="material-icons">add</i> Add Match</div></div>`; }
    function renderGroupTeamInputs(group) {
        const container = document.getElementById(`group-${group}-teams`); if(!container) return; if(!tournamentState.groups || !tournamentState.groups[group]) tournamentState.groups[group] = [];
        container.innerHTML = tournamentState.groups[group].map((teamName, index) => `<input type="text" value="${teamName}" oninput="updateTeamName('${group}', ${index}, this.value)" placeholder="Enter Team Name" style="margin-bottom: 8px;">`).join('');
    }
    function addTeamInput(group) { if(!tournamentState.groups) tournamentState.groups = {}; if(!tournamentState.groups[group]) tournamentState.groups[group] = []; tournamentState.groups[group].push(''); renderGroupTeamInputs(group); }
    function updateTeamName(group, index, name) { tournamentState.groups[group][index] = name; updateAllFixtureDropdowns(); }
    function addMatchRow(stageKey) { if(!tournamentState.fixtures[stageKey]) tournamentState.fixtures[stageKey] = []; tournamentState.fixtures[stageKey].push({ team1: '', team2: '', played: false }); renderMatchRows(stageKey); }
    function renderMatchRows(stageKey) {
        const container = document.getElementById(`${stageKey}-stage-matches`); if (!container) return; if (!tournamentState.fixtures[stageKey]) tournamentState.fixtures[stageKey] = [];
        container.innerHTML = tournamentState.fixtures[stageKey].map((match, index) => `<div class="match-row">${createTeamDropdown(stageKey, index, 'team1')}<span>vs</span>${createTeamDropdown(stageKey, index, 'team2')}</div>`).join('');
    }
    function updateAllFixtureDropdowns() { ['group', 'quarter', 'semi', 'final'].forEach(stageKey => { const container = document.getElementById(`${stageKey}-stage-matches`); if (container) renderMatchRows(stageKey); }); }
    function getTeamOptions() { return [...new Set(Object.values(tournamentState.groups || {}).flat().filter(Boolean))]; }
    function createTeamDropdown(stageKey, matchIndex, teamKey) {
        const teams = getTeamOptions(); const selectedTeam = tournamentState.fixtures[stageKey][matchIndex][teamKey];
        let optionsHTML = '<option value="">Select Team</option>';
        teams.forEach(team => { optionsHTML += `<option value="${team}" ${team === selectedTeam ? 'selected' : ''}>${team}</option>`; });
        return `<select onchange="updateMatchTeam('${stageKey}', ${matchIndex}, '${teamKey}', this.value)">${optionsHTML}</select>`;
    }
    function updateMatchTeam(stageKey, matchIndex, teamKey, teamName) { tournamentState.fixtures[stageKey][matchIndex][teamKey] = teamName; }
    function renderPointsTable() {
        const content = document.getElementById('tournament-content-wrapper');
        const saveBtnContainer = document.getElementById('tournament-save-btn-container');
        let tableHTML = '';
        for (const group of ['A', 'B', 'C', 'D']) {
            const teams = (tournamentState.groups && tournamentState.groups[group]) ? tournamentState.groups[group].filter(Boolean) : [];
            if (teams.length > 0) {
                if (!tournamentState.points) tournamentState.points = {}; if (!tournamentState.points[group]) tournamentState.points[group] = {};
                tableHTML += `<div class="card"><h3>Points Table - Group ${group}</h3><div class="table-responsive"><table class="points-table">
                    <thead><tr><th>Team</th><th>P</th><th>W</th><th>L</th><th>Pts</th><th>NRR</th></tr></thead><tbody>`;
                teams.forEach(team => {
                    if (!tournamentState.points[group][team]) tournamentState.points[group][team] = { p: 0, w: 0, l: 0, pts: 0, nrr: '' };
                    const teamData = tournamentState.points[group][team];
                    tableHTML += `<tr>
                        <td>${team}</td>
                        <td><input type="number" value="${teamData.p}" oninput="updatePointsData('${group}', '${team}', 'p', this.value)"></td>
                        <td><input type="number" value="${teamData.w}" oninput="updatePointsData('${group}', '${team}', 'w', this.value)"></td>
                        <td><input type="number" value="${teamData.l}" oninput="updatePointsData('${group}', '${team}', 'l', this.value)"></td>
                        <td><input type="number" value="${teamData.pts}" oninput="updatePointsData('${group}', '${team}', 'pts', this.value)"></td>
                        <td><input type="text" value="${teamData.nrr}" oninput="updatePointsData('${group}', '${team}', 'nrr', this.value)"></td>
                    </tr>`;
                });
                tableHTML += `</tbody></table></div></div>`;
            }
        }
        content.innerHTML = tableHTML || '<div class="card"><p>No teams added in Fixtures tab.</p></div>';
        saveBtnContainer.style.display = 'block';
    }

    function updatePointsData(group, team, key, value) {
        if (!tournamentState.points) tournamentState.points = {}; if (!tournamentState.points[group]) tournamentState.points[group] = {};
        if (!tournamentState.points[group][team]) tournamentState.points[group][team] = {};
        tournamentState.points[group][team][key] = value;
    }

    function renderTournamentResults() {
        const content = document.getElementById('tournament-content-wrapper');
        const saveBtnContainer = document.getElementById('tournament-save-btn-container');
        let resultsHTML = '';
        for (const stage of ['group', 'quarter', 'semi', 'final']) {
            if (!tournamentState.fixtures || !tournamentState.fixtures[stage]) continue;
            const matches = tournamentState.fixtures[stage].filter(m => m.team1 && m.team2);
            if (matches.length > 0) {
                const stageTitle = stage.charAt(0).toUpperCase() + stage.slice(1) + ' Stage Results';
                resultsHTML += `<div class="card"><h3>${stageTitle}</h3>`;
                matches.forEach((match, index) => {
                    const resultId = `${stage}-${index}`;
                    const resultData = (tournamentState.results && tournamentState.results[resultId]) ? tournamentState.results[resultId] : { score1: '', score2: '', summary: '', dateTime: '' };
                    resultsHTML += `<div class="result-match-item">
                        <div style="margin-bottom: 10px;">
                           <input type="text" class="date-time-input" placeholder="Enter Date & Time" value="${resultData.dateTime || ''}" oninput="updateResult('${resultId}', 'dateTime', this.value)">
                        </div>
                        <div class="score-entry-row">
                            <span class="team-name">${match.team1}</span>
                            <input type="text" class="score-input" placeholder="Score/Wkts" value="${resultData.score1}" oninput="updateResult('${resultId}', 'score1', this.value)">
                        </div>
                        <div class="score-entry-row">
                            <span class="team-name">${match.team2}</span>
                            <input type="text" class="score-input" placeholder="Score/Wkts" value="${resultData.score2}" oninput="updateResult('${resultId}', 'score2', this.value)">
                        </div>
                        <textarea class="summary-input" placeholder="Write result summary..." oninput="updateResult('${resultId}', 'summary', this.value)">${resultData.summary}</textarea>
                    </div>`;
                });
                resultsHTML += `</div>`;
            }
        }
        content.innerHTML = resultsHTML || '<div class="card"><p>No matches set in Fixtures tab.</p></div>';
        saveBtnContainer.style.display = 'block';
    }
    function updateResult(resultId, key, value) {
        if(!tournamentState.results) tournamentState.results = {};
        if (!tournamentState.results[resultId]) {
            tournamentState.results[resultId] = { score1: '', score2: '', summary: '', dateTime: '' };
        }
        tournamentState.results[resultId][key] = value;
    }

    // --- Tournament Points Auto-Update Functions ---
    function findTeamGroup(teamName) {
        if (!tournamentState.groups) return null;
        for (const group in tournamentState.groups) {
            if (tournamentState.groups[group].includes(teamName)) {
                return group;
            }
        }
        return null;
    }

    function updateTeamPointsInTable(teamName, groupName, isWin, isDraw) {
        if (!groupName || !tournamentState.points || !tournamentState.points[groupName]) return;
        if (!tournamentState.points[groupName][teamName]) {
            tournamentState.points[groupName][teamName] = { p: 0, w: 0, l: 0, pts: 0, nrr: '' };
        }
        const teamData = tournamentState.points[groupName][teamName];
        teamData.p = (parseInt(teamData.p) || 0) + 1;
        if (isWin) {
            teamData.w = (parseInt(teamData.w) || 0) + 1;
            teamData.pts = (parseInt(teamData.pts) || 0) + 2;
        } else if (isDraw) {
            teamData.pts = (parseInt(teamData.pts) || 0) + 1;
        } else {
            teamData.l = (parseInt(teamData.l) || 0) + 1;
        }
    }

    function updateTournamentPoints(completedMatch) {
        const team1 = completedMatch.innings[1].team;
        const team2 = completedMatch.innings[2].team;
        if (!tournamentState.fixtures) return;

        let fixtureFound = null;
        let fixtureStage = null;
        for (const stage in tournamentState.fixtures) {
            const fixtureIndex = tournamentState.fixtures[stage].findIndex(f =>
                !f.played && ((f.team1 === team1 && f.team2 === team2) || (f.team1 === team2 && f.team2 === team1))
            );
            if (fixtureIndex !== -1) {
                fixtureFound = tournamentState.fixtures[stage][fixtureIndex];
                fixtureStage = stage;
                break;
            }
        }

        if (!fixtureFound) return;

        let winner = null, loser = null, isDraw = false;
        if (completedMatch.result.includes('Draw')) {
            isDraw = true;
        } else if (completedMatch.result.includes('won by')) {
            winner = completedMatch.result.startsWith(team1) ? team1 : team2;
            loser = (winner === team1) ? team2 : team1;
        } else {
            return;
        }

        if (fixtureStage === 'group') {
            const group1 = findTeamGroup(team1);
            const group2 = findTeamGroup(team2);

            if (group1 && group2) {
                 if (isDraw) {
                    updateTeamPointsInTable(team1, group1, false, true);
                    updateTeamPointsInTable(team2, group2, false, true);
                 } else {
                    updateTeamPointsInTable(winner, group1, true, false);
                    updateTeamPointsInTable(loser, group2, false, false);
                 }
                 fixtureFound.played = true;
                 saveData();
                 showToast('Tournament points updated!');
            }
        }
    }

    // *** START: NEW FUNCTION 2 ***
    // This function runs when the "Login" button is clicked
    function handleLogin() {
        const emailInput = document.getElementById('login-email-input');
        const passwordInput = document.getElementById('login-password-input');
        const email = emailInput.value.trim();
        const password = passwordInput.value; // Don't trim password

        if (!email || !password) {
            showToast("Please enter both email and password.");
            return;
        }

        // Sign in with Firebase
        auth.signInWithEmailAndPassword(email, password)
            .then(async (userCredential) => {
                // Sign-in successful.
                currentUser = userCredential.user;
                console.log("Admin sign-in successful:", currentUser.uid);
                
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                await loadData(); // Load data after successful login
                checkForInProgressMatch();
            })
            .catch(error => {
                // Handle Errors
                console.error("Admin sign-in failed:", error);
                // ‡¶è‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    showToast("Incorrect Email or Password!");
                } else {
                    showToast("Login failed. Check internet.");
                }
                passwordInput.value = '';
            });
    }
    // *** END: NEW FUNCTION 2 ***

    // --- PDF DOWNLOAD & Initial setup ---
    document.addEventListener('DOMContentLoaded', ()=> {
        
        // *** START: NEW AUTHENTICATION CHECK ***
        // Check if the user is already logged in when the page loads
        checkAuthState();
        // *** END: NEW AUTHENTICATION CHECK ***


        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('login-password-input').addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                handleLogin();
            }
        });

        document.getElementById('full-scorecard-btn').addEventListener('click', () => {
            renderMatchSummary(matchState);
            navigate('match-summary-screen');
        });

        document.getElementById('tournament-nav').addEventListener('click', (e) => {
            const tabItem = e.target.closest('.nav-item'); if (!tabItem) return;
            document.querySelectorAll('#tournament-nav .nav-item').forEach(i => i.classList.remove('active'));
            tabItem.classList.add('active');
            const tab = tabItem.dataset.tab;
            const saveBtnContainer = document.getElementById('tournament-save-btn-container');
            if (tab === 'fixtures') { renderTournamentFixtures(); saveBtnContainer.style.display = 'block'; }
            if (tab === 'points') { renderPointsTable(); saveBtnContainer.style.display = 'block'; }
            if (tab === 'results') { renderTournamentResults(); saveBtnContainer.style.display = 'block'; }
        });

        const downloadBtn = document.getElementById('download-pdf-btn');
        if (downloadBtn) {
             downloadBtn.addEventListener('click', async () => {
                 const { jsPDF } = window.jspdf;
 
                 const originalBtnText = downloadBtn.innerHTML;
                 downloadBtn.innerHTML = 'Downloading...';
                 downloadBtn.disabled = true;
 
                 try {
                     const contentWrapper = document.getElementById('summary-content-wrapper');
                     const displayedMatch = appData.history.find(m => m.id === contentWrapper.dataset.matchId) || matchState;
                     const team1Name = displayedMatch?.innings?.[1]?.team || 'TeamA';
                     const team2Name = displayedMatch?.innings?.[2]?.team || 'TeamB';

                     const pdf = new jsPDF('p', 'mm', 'a4');
                     const pdfWidth = pdf.internal.pageSize.getWidth();
                     const margin = 10;
                     const contentWidth = pdfWidth - (margin * 2);

                     const addCombinedElementToPdf = async (elementIds, isFirstPage = false) => {
                         const tempContainer = document.createElement('div');
                         tempContainer.style.position = 'absolute';
                         tempContainer.style.left = '-9999px';
                         tempContainer.style.width = `${contentWidth * 3.78}px`; // Convert mm to px for rendering
                         tempContainer.classList.add('pdf-render-mode'); // PDF ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                         tempContainer.style.padding = '1px';
                         
                         // Add a header with team names for each page
                         const headerDiv = document.createElement('div');                         
                         headerDiv.innerHTML = `<div class="card" style="text-align: center; background: linear-gradient(135deg, var(--primary-dark-color), var(--primary-color)); color: white; padding: 5px;">
                                                    <h2 style="margin:0; font-size: 20px;">Cricket Carnival 2025</h2>
                                                    <p style="margin: 2px 0 0; font-size: 12px;">${team1Name} vs ${team2Name}</p>
                                                </div>`;
                         tempContainer.appendChild(headerDiv);

                         elementIds.forEach(id => {
                             const element = document.getElementById(id);
                             if (element) {
                                 tempContainer.appendChild(element.cloneNode(true));
                             }
                         });

                         document.body.appendChild(tempContainer);

                         try {
                             // ‡¶∏‡ßç‡¶ï‡ßá‡¶≤ ‡¶¨‡¶æ‡ßú‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶Ø‡¶æ‡¶§‡ßá ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶Ü‡¶∞‡¶ì ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶õ‡ßã‡¶ü ‡¶π‡ßü
                             const canvas = await html2canvas(tempContainer, { scale: 3, useCORS: true, width: tempContainer.offsetWidth });
                             const imgData = canvas.toDataURL('image/png');
                             const imgHeight = (canvas.height * contentWidth) / canvas.width;

                             const pageHeight = pdf.internal.pageSize.getHeight();
                             let heightLeft = imgHeight;
                             let position = margin;

                             if (!isFirstPage) {
                                 pdf.addPage();
                             }
                             // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                             pdf.addImage(imgData, 'PNG', margin, position, contentWidth, imgHeight, undefined, 'FAST');
                             heightLeft -= (pageHeight - margin * 2);

                             // ‡¶Ø‡¶¶‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶è‡¶ï ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                             while (heightLeft > 0) {
                                 position = -heightLeft + margin; // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
                                 pdf.addPage();
                                 pdf.addImage(imgData, 'PNG', margin, position, contentWidth, imgHeight, undefined, 'FAST');
                                 heightLeft -= (pageHeight - margin * 2);
                             }
                         } finally {
                             document.body.removeChild(tempContainer);
                         }
                     };
 
                     // Page 1: 1st Innings
                     const firstInningElements = ['toss-summary-info', 'inning-summary-1-batting', 'inning-summary-1-bowling', 'inning-summary-1-fow'];
                     await addCombinedElementToPdf(firstInningElements, true);
 
                     // Check if 2nd innings exists
                     if (document.getElementById('inning-summary-2-batting')) {
                         // Page 2: 2nd Innings
                         // --- *** ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶ï‡ßã‡¶°: ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá *** ---
                         const secondInningElements = ['inning-summary-2-batting', 'inning-summary-2-bowling', 'inning-summary-2-fow', 'match-result-summary'];
                         await addCombinedElementToPdf(secondInningElements, false);
                     }
 
                     // --- Save the PDF ---
                     pdf.save(`Scorecard_${team1Name}_vs_${team2Name}.pdf`);
 
                     showToast("PDF Downloaded!");
                 } catch (err) {
                     console.error("PDF generation failed", err);
                     showToast("Failed to generate PDF. Please try again.");
                 } finally {
                     downloadBtn.innerHTML = originalBtnText;
                     downloadBtn.disabled = false;
                 }
            });
        }

¬† ¬† ¬† ¬† const showOversBtn = document.getElementById('show-overs-btn');
¬† ¬† ¬† ¬† if (showOversBtn) {
¬† ¬† ¬† ¬† ¬† ¬† showOversBtn.addEventListener('click', () => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // ‡¶ï‡ßã‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶§‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const contentWrapper = document.getElementById('summary-content-wrapper');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const matchId = contentWrapper.dataset.matchId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö‡¶ü‡¶ø ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const displayedMatch = appData.history.find(m => m.id === matchId) || matchState;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (displayedMatch) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† renderOversDetails(displayedMatch);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† navigate('overs-details-screen');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showToast("Error: Match data could not be loaded.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† }

function renderOversDetails(matchData) {
¬† ¬† const content = document.getElementById('overs-details-content');
¬† ¬† content.innerHTML = '';

¬† ¬† const renderInningOvers = (inningNum) => {
¬† ¬† ¬† ¬† const inning = matchData.innings[inningNum];
¬† ¬† ¬† ¬† if (!inning || !inning.team || !inning.allOvers || inning.allOvers.length === 0) return '';

        // ‡¶á‡¶®‡¶ø‡¶Ç‡¶∏‡ßá‡¶∞ ‡¶π‡ßá‡¶°‡¶æ‡¶∞
¬† ¬† ¬† ¬† let html = `<div class="card" style="margin-bottom: 16px;">
                        <h3 style="margin: 0;">${inning.team} - ${inning.score}/${inning.wickets}</h3>
                    </div>`;

        // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ì‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
¬† ¬† ¬† ¬† inning.allOvers.forEach((over, index) => {
            // ‡¶¨‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
¬† ¬† ¬† ¬† ¬† ¬† const ballsHTML = over.balls.map(ball => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const ballStr = String(ball);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let ballClass = 'ball-event';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (ballStr.includes('W')) ballClass += ' wicket';
                // ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶¨‡¶æ‡¶â‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®
                // if (ballStr.includes('4') || ballStr.includes('6')) ballClass += ' boundary';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return `<span class="${ballClass}">${ball}</span>`;
¬† ¬† ¬† ¬† ¬† ¬† }).join('');

            // ‡¶™‡ßÅ‡¶∞‡ßã ‡¶ì‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶°
¬† ¬† ¬† ¬† ¬† ¬† html += `<div class="over-summary-card">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="over-summary-header">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <h4>Over ${index + 1} (Bowler: ${over.bowlerName})</h4>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="over-summary-balls">${ballsHTML}</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>`;
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† return html;
¬† ¬† };

    // ‡ßß‡¶Æ ‡¶á‡¶®‡¶ø‡¶Ç‡¶∏ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
¬† ¬† content.innerHTML += renderInningOvers(1);
    
    // ‡ß®‡ßü ‡¶á‡¶®‡¶ø‡¶Ç‡¶∏ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
¬† ¬† const inning2Overs = renderInningOvers(2);
¬† ¬† if (inning2Overs) {
        // ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶á‡¶®‡¶ø‡¶Ç‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶ï ‡¶¶‡¶ø‡¶®
¬† ¬† ¬† ¬† content.innerHTML += '<hr style="margin: 20px 0;">' + inning2Overs;
¬† ¬† }
}
    });
</script>
</body>
</html>
